<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder Ultimate</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: #1e1e1e; color: white; overflow: hidden; }
        .panel__top { padding: 10px 20px; background: #1e1e1e; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 60px; }
        .btns-right { display: flex; gap: 10px; align-items: center; }
        input, select { background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; }
        button { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; background: #444; color: white; }
        .btn-github { background: #2ea44f; }
        #status-display { font-size: 13px; color: #aaa; }
        #gjs { height: calc(100vh - 60px) !important; }
        .success-text { color: #2ea44f; font-weight: bold; }
    </style>
</head>
<body>

    <div class="panel__top">
        <div class="logo"><b>OpenBuilder Ultimate</b></div>
        <div class="btns-right">
            <div id="status-display">Ready.</div>
            <select id="my-sites" onchange="loadExistingSite(this.value)"><option>My Sites (Load...)</option></select>
            <input type="text" id="site-name" placeholder="Project Name">
            <button class="btn-github" onclick="publishSite()">ðŸš€ Publish & Go Live</button>
        </div>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = {
            apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ",
            authDomain: "web-maker-c6261.firebaseapp.com",
            projectId: "web-maker-c6261"
        };
        firebase.initializeApp(firebaseConfig);

        // 1. INITIALIZE EDITOR WITH CUSTOM TRAITS
        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            fromElement: true,
            storageManager: false,
            assetManager: {
                upload: 'https://api.cloudinary.com/v1_1/demo/image/upload', // Demo endpoint
                params: { upload_preset: 'unsigned_preset' }
            },
            blockManager: {
                blocks: [
                    { id: 'text', label: 'Text', content: '<p>Edit your content</p>' },
                    { 
                        id: 'paypal', 
                        label: '<b>PayPal Button</b>', 
                        attributes: { class: 'gjs-fonts gjs-f-b1' },
                        content: {
                            type: 'paypal-button',
                            classes: ['paypal-container']
                        }
                    }
                ]
            }
        });

        // 2. DEFINE CUSTOM PAYPAL COMPONENT (Sidebar Editing)
        editor.DomComponents.addType('paypal-button', {
            model: {
                defaults: {
                    tagName: 'div',
                    attributes: { 'data-price': '10.00', 'data-item': 'My Product' },
                    components: `
                        <div style="padding:20px; border:2px solid #ffc439; border-radius:10px; text-align:center; color:black; background:white;">
                            <h3>Buy <span class="item-name">My Product</span></h3>
                            <p>$<span class="item-price">10.00</span></p>
                            <div style="background:#ffc439; padding:10px; border-radius:5px; font-weight:bold;">PayPal Active on Live</div>
                        </div>`,
                    traits: [
                        { type: 'text', label: 'Product Name', name: 'data-item' },
                        { type: 'text', label: 'Price', name: 'data-price' }
                    ],
                },
                init() {
                    this.on('change:attributes:data-item', this.updateContent);
                    this.on('change:attributes:data-price', this.updateContent);
                },
                updateContent() {
                    const name = this.getAttributes()['data-item'];
                    const price = this.getAttributes()['data-price'];
                    this.getEl().querySelector('.item-name').innerText = name;
                    this.getEl().querySelector('.item-price').innerText = price;
                }
            }
        });

        // 3. LOAD EXISTING REPOS
        window.loadExistingSite = async function(repoName) {
            if (!repoName || repoName.includes("Load")) return;
            const status = document.getElementById('status-display');
            status.innerText = "Importing site...";

            try {
                const result = await firebase.auth().signInWithPopup(new firebase.auth.GithubAuthProvider());
                const octokit = new Octokit({ auth: result.credential.accessToken });
                
                const res = await octokit.repos.getContent({
                    owner: result.additionalUserInfo.username,
                    repo: repoName,
                    path: 'index.html'
                });

                const htmlContent = atob(res.data.content);
                // Extract only the body content to put back into editor
                const bodyMatch = htmlContent.match(/<body>([\s\S]*)<\/body>/);
                if (bodyMatch) editor.setComponents(bodyMatch[1]);
                
                document.getElementById('site-name').value = repoName;
                status.innerText = "Loaded " + repoName;
            } catch (e) { status.innerText = "Load failed."; }
        };

        // 4. PUBLISH LOGIC
        window.publishSite = async function() {
            const status = document.getElementById('status-display');
            const siteName = document.getElementById('site-name').value.trim().replace(/\s+/g, '-').toLowerCase();
            if (!siteName) return alert("Enter site name!");

            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo');

            try {
                const result = await firebase.auth().signInWithPopup(provider);
                const token = result.credential.accessToken;
                const user = result.additionalUserInfo.username;
                const octokit = new Octokit({ auth: token });

                status.innerText = "ðŸš€ Deploying...";

                // Create or check Repo
                try { await octokit.request('POST /user/repos', { name: siteName, auto_init: true }); } catch (e) {}

                // Build Final Code with PayPal Script
                const html = editor.getHtml();
                const css = editor.getCss();
                const finalCode = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>${css}</style>
                    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"><\/script>
                </head>
                <body>
                    ${html}
                    <script>
                        document.querySelectorAll('.paypal-container').forEach(el => {
                            const price = el.getAttribute('data-price');
                            const name = el.getAttribute('data-item');
                            el.innerHTML = '<div id="btn-' + Math.random().toString(36).substr(2,9) + '"></div>';
                            paypal.Buttons({
                                createOrder: (data, actions) => actions.order.create({
                                    purchase_units: [{ description: name, amount: { value: price } }]
                                })
                            }).render(el.firstChild);
                        });
                    <\/script>
                </body>
                </html>`;

                // Get SHA if exists
                let sha = null;
                try {
                    const existing = await octokit.repos.getContent({ owner: user, repo: siteName, path: 'index.html' });
                    sha = existing.data.sha;
                } catch (e) {}

                await octokit.repos.createOrUpdateFileContents({
                    owner: user, repo: siteName, path: 'index.html',
                    message: 'Update', content: btoa(unescape(encodeURIComponent(finalCode))), sha
                });

                // Enable Pages
                try { await octokit.request('POST /repos/{owner}/{repo}/pages', { owner: user, repo: siteName, source: { branch: 'main', path: '/' } }); } catch (e) {}

                status.innerHTML = `<span class="success-text">Published!</span> <a href="https://${user}.github.io/${siteName}/" target="_blank" style="color:#58a6ff">View</a>`;
                
                // Refresh site list
                fetchRepos(octokit, user);
            } catch (error) {
                status.innerText = "Error: " + error.message;
            }
        };

        // Fetch user's repos to populate the dropdown
        async function fetchRepos(octokit, user) {
            const repos = await octokit.repos.listForAuthenticatedUser({ sort: 'updated', per_page: 50 });
            const sel = document.getElementById('my-sites');
            sel.innerHTML = '<option>Load Existing Site...</option>' + 
                repos.data.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
        }

        // Auto-fetch on login
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                // To fetch repos we need the token from the login result, 
                // for now, we'll fetch when they click the dropdown or publish.
            }
        });
    </script>
</body>
</html>
