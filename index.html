<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenBuilder | Pro-Persistence</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background: #080808; color: #fff; font-family: -apple-system, sans-serif; }
        
        /* Monochromatic UI */
        .gjs-one-bg { background-color: #0d0d0d !important; }
        .gjs-two-bg { background-color: #121212 !important; }
        .gjs-three-bg { background-color: #1a1a1a !important; }
        .gjs-four-color { color: #fff !important; }
        .gjs-pn-buttons { background-color: #0d0d0d !important; border-bottom: 1px solid #222 !important; }
        
        /* Sidebar Styles */
        #sidebar {
            position: absolute; top: 40px; left: 0; width: 260px; bottom: 0;
            background: #0d0d0d; border-right: 1px solid #222; z-index: 1005; 
            display: none; padding: 20px; box-sizing: border-box;
        }
        .item-row { 
            padding: 12px; color: #666; cursor: pointer; border-radius: 4px;
            margin-bottom: 5px; font-size: 12px; transition: 0.2s; border: 1px solid transparent;
        }
        .item-row:hover, .item-row.active { background: #1a1a1a; color: #3b82f6; border-color: #333; }
        
        /* Status Bubble */
        #status-bubble {
            position: fixed; bottom: 25px; right: 25px; padding: 12px 24px;
            background: #3b82f6; color: white; border-radius: 4px; font-size: 11px;
            font-weight: 800; display: none; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-transform: uppercase; letter-spacing: 1px;
        }

        .action-btn { width: 100%; margin-top: 10px; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 4px; font-size: 10px; }
        .btn-main { background: #fff; color: #000; }
        .btn-sec { background: #222; color: #fff; border: 1px solid #444; }
    </style>
</head>
<body>

    <div id="status-bubble">Syncing...</div>

    <div id="sidebar">
        <span style="font-size: 9px; color: #444; text-transform: uppercase; letter-spacing: 2px;">Project Storage</span>
        <input type="text" id="repo-input" placeholder="GitHub Repository Name" style="width:100%; background:#000; border:1px solid #333; color:white; padding:10px; margin-top:10px; border-radius:4px; font-size:12px;">
        <button onclick="importProject()" class="action-btn btn-sec">â†“ IMPORT PROJECT JSON</button>

        <hr style="border:0; border-top:1px solid #222; margin:25px 0;">
        
        <span style="font-size: 9px; color: #444; text-transform: uppercase; letter-spacing: 2px;">Site Pages</span>
        <div id="page-list" style="margin-top:15px;"></div>
        <button onclick="addPage()" class="action-btn btn-main">+ NEW PAGE</button>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            storageManager: false,
            pageManager: true,
            allowScripts: 1,
            canvas: { styles: ['https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap'] },
            blockManager: {
                blocks: [
                    {
                        id: 'text', label: 'Draggable Text', category: 'Basic',
                        content: { type: 'text', content: 'Double click to edit', style: { position: 'absolute', top: '100px', left: '100px', color: '#fff' } }
                    },
                    {
                        id: 'image', label: 'Draggable Image', category: 'Basic',
                        content: { type: 'image', style: { position: 'absolute', top: '150px', left: '150px', width: '300px' } }
                    },
                    {
                        id: 'btn', label: 'Action Button', category: 'General',
                        content: { 
                            tagName: 'a', content: 'Explore', 
                            style: { position: 'absolute', top: '250px', left: '100px', padding: '14px 28px', background: '#3b82f6', color: '#fff', 'text-decoration': 'none', 'border-radius': '4px', 'font-weight': 'bold' },
                            traits: ['href'] 
                        }
                    }
                ]
            }
        });

        const pm = editor.Pages;
        const pn = editor.Panels;

        // Toolbar Buttons
        pn.addButton('options', [
            {
                id: 'sidebar-toggle', className: 'fa fa-bars',
                command: () => {
                    const sb = document.getElementById('sidebar');
                    sb.style.display = sb.style.display === 'none' ? 'block' : 'none';
                    refreshPageList();
                }
            },
            { id: 'undo', className: 'fa fa-undo', command: 'core:undo' },
            { id: 'redo', className: 'fa fa-repeat', command: 'core:redo' },
            { id: 'push-gh', className: 'fa fa-paper-plane', command: () => silentPush(), attributes: { title: 'Save & Publish' } }
        ]);

        window.addPage = () => {
            const name = prompt("Page Filename:");
            if (name) {
                pm.add({ id: name, component: `<div style="height:100vh; background:#080808; position:relative;"><h1>${name}</h1></div>` });
                refreshPageList();
            }
        };

        const refreshPageList = () => {
            const list = document.getElementById('page-list');
            list.innerHTML = '';
            pm.getAll().forEach(page => {
                const row = document.createElement('div');
                row.className = `item-row ${page.id === pm.getSelected().id ? 'active' : ''}`;
                row.innerHTML = `<span>${page.id}.html</span>`;
                row.onclick = () => { pm.select(page.id); refreshPageList(); };
                list.appendChild(row);
            });
        };

        let ghToken = "", ghUser = "";

        // --- THE "SILENT PUSH" & PROJECT JSON ENGINE ---
        const silentPush = async () => {
            const repo = document.getElementById('repo-input').value;
            if (!repo) return alert("Please enter a Repository Name in the sidebar.");

            const status = document.getElementById('status-bubble');
            status.innerText = "Pushing to GitHub...";
            status.style.display = "block";

            if (!ghToken) {
                const provider = new firebase.auth.GithubAuthProvider();
                provider.addScope('repo');
                const result = await firebase.auth().signInWithPopup(provider);
                ghToken = result.credential.accessToken;
                ghUser = result.additionalUserInfo.username;
            }

            const octo = new Octokit({ auth: ghToken });

            try {
                // Ensure Repo
                try { await octo.request('POST /user/repos', { name: repo, auto_init: true }); } catch(e) {}

                // 1. UPLOAD PROJECT JSON (The Save State)
                const projectData = JSON.stringify(editor.getProjectData());
                await upload(octo, repo, 'project-data.json', projectData);

                // 2. UPLOAD ALL PAGES
                const pages = pm.getAll();
                for (const page of pages) {
                    pm.select(page.id);
                    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
                    
                    // Logic: First page created or "index" is index.html
                    const isIndex = (page.id === 'index' || pages.indexOf(page) === 0);
                    const filename = isIndex ? 'index.html' : `${page.id}.html`;
                    
                    await upload(octo, repo, filename, html);
                }

                status.innerText = "Project Saved & Published!";
                setTimeout(() => status.style.display = "none", 3000);
            } catch (err) {
                status.innerText = "Push Failed!";
                console.error(err);
            }
        };

        // --- IMPORT ENGINE ---
        window.importProject = async () => {
            const repo = document.getElementById('repo-input').value;
            if (!repo) return alert("Enter the Repository Name to import from.");

            const status = document.getElementById('status-bubble');
            status.innerText = "Importing JSON...";
            status.style.display = "block";

            if (!ghToken) {
                const provider = new firebase.auth.GithubAuthProvider();
                provider.addScope('repo');
                const result = await firebase.auth().signInWithPopup(provider);
                ghToken = result.credential.accessToken;
                ghUser = result.additionalUserInfo.username;
            }

            const octo = new Octokit({ auth: ghToken });

            try {
                const res = await octo.repos.getContent({ owner: ghUser, repo: repo, path: 'project-data.json' });
                const jsonContent = atob(res.data.content);
                editor.loadProjectData(JSON.parse(jsonContent));
                
                status.innerText = "Import Successful!";
                refreshPageList();
                setTimeout(() => status.style.display = "none", 3000);
            } catch (e) {
                status.innerText = "No Save Data Found.";
                setTimeout(() => status.style.display = "none", 3000);
            }
        };

        async function upload(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: ghUser, repo: repo, path: path }); sha = res.data.sha; } catch(e) {}
            return octo.repos.createOrUpdateFileContents({
                owner: ghUser, repo: repo, path: path,
                message: 'OpenBuilder Auto-Sync',
                content: btoa(unescape(encodeURIComponent(content))),
                sha: sha
            });
        }

        editor.on('load', () => {
            if (!pm.getSelected()) pm.add({ id: 'index', component: '<div style="height:100vh; background:#080808; position:relative;"></div>' });
        });
    </script>
</body>
</html>
