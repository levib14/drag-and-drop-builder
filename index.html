<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder | Sign In & Publish</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; overflow: hidden; }
        .panel__top { 
            padding: 10px 20px; 
            background: #1e1e1e; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .btns-right { display: flex; gap: 10px; align-items: center; }
        #site-name {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            outline: none;
            width: 200px;
        }
        button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-download { background: #444; color: white; }
        .btn-github { background: #2ea44f; color: white; }
        .btn-github:hover { background: #2c974b; transform: translateY(-1px); }
        #gjs { height: calc(100vh - 56px) !important; }
        #loader {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>

    <div id="loader"><h1>Publishing to GitHub...</h1><p id="loader-status">Please wait a moment.</p></div>

    <div class="panel__top">
        <div class="logo"><b>OpenBuilder</b></div>
        <div class="btns-right">
            <input type="text" id="site-name" placeholder="Website Name (No spaces)">
            <button class="btn-download" onclick="downloadSite()">Download HTML</button>
            <button class="btn-github" onclick="loginAndPublish()">ðŸš€ Sign in & Push</button>
            <button style="background:transparent; color:#888; font-size:12px;" onclick="firebase.auth().signOut().then(() => alert('Signed out! Clear your cache or Revoke the app on GitHub to reset permissions.'))">Sign Out</button>
        </div>
    </div>

    <div id="gjs">
        <section style="padding: 100px 50px; text-align: center; background-color: #f9f9f9;">
            <h1>Instant E-Commerce Site</h1>
            <p>Edit this text, drag an image, or add a PayPal button below.</p>
        </section>
    </div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = {
            apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ",
            authDomain: "web-maker-c6261.firebaseapp.com",
            projectId: "web-maker-c6261"
        };
        
        firebase.initializeApp(firebaseConfig);
        const provider = new firebase.auth.GithubAuthProvider();
        
        // FORCING REPO SCOPE
        provider.addScope('repo'); 
        // Force GitHub to show the authorization prompt again if permissions were denied
        provider.setCustomParameters({ 'allow_signup': 'false' });

        const editor = grapesjs.init({
            container: '#gjs',
            fromElement: true,
            height: '100%',
            storageManager: false,
            blockManager: {
                blocks: [
                    { id: 'section', label: 'Section', content: '<section style="padding:50px; text-align:center;"><h2>New Section</h2></section>' },
                    { id: 'text', label: 'Text', content: '<p>Insert your text here...</p>' },
                    { id: 'image', label: 'Image', content: { type: 'image' } },
                    { id: 'paypal', label: '<b>PayPal Button</b>', content: `
                        <div style="padding: 20px; text-align: center; border: 2px solid #ffc439; border-radius: 8px;">
                            <div id="paypal-button-container"></div>
                            <p style="font-size:12px; color:#666;">(Button will activate after publish)</p>
                        </div>` 
                    }
                ]
            }
        });

        window.loginAndPublish = async function() {
            const siteName = document.getElementById('site-name').value.trim().replace(/\s+/g, '-').toLowerCase();
            const statusText = document.getElementById('loader-status');
            
            if (!siteName) return alert("Please enter a name for your website.");

            try {
                // 1. Authenticate with GitHub
                const result = await firebase.auth().signInWithPopup(provider);
                const token = result.credential.accessToken;
                const githubUser = result.additionalUserInfo.username;

                if (!token) throw new Error("No access token found.");

                // DEBUGGER: Check what permissions GitHub actually gave us
                const checkAuth = await fetch(`https://api.github.com/zen`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const activeScopes = checkAuth.headers.get('x-oauth-scopes');
                console.log("Current Permissions:", activeScopes);

                if (!activeScopes || !activeScopes.includes('repo')) {
                    throw new Error("Missing 'repo' permission. Please Revoke the app on GitHub and Sign In again.");
                }

                document.getElementById('loader').style.display = 'flex';
                statusText.innerText = "Creating repository...";

                const octokit = new Octokit({ auth: token });

                // 2. Create the Repo
                await octokit.request('POST /user/repos', {
                    name: siteName,
                    auto_init: true,
                    description: "Site built with OpenBuilder"
                });

                // Wait for GitHub to initialize the repo
                await new Promise(r => setTimeout(r, 2000));
                statusText.innerText = "Uploading files...";

                // 3. Prep HTML
                const html = editor.getHtml();
                const css = editor.getCss();
                const finalCode = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${siteName}</title><style>${css}</style><script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"><\/script></head><body>${html}<script>if(document.getElementById('paypal-button-container')){paypal.Buttons().render('#paypal-button-container');}<\/script></body></html>`;

                // 4. Upload index.html
                await octokit.repos.createOrUpdateFileContents({
                    owner: githubUser,
                    repo: siteName,
                    path: 'index.html',
                    message: 'Initial deployment',
                    content: btoa(unescape(encodeURIComponent(finalCode)))
                });

                statusText.innerText = "Activating GitHub Pages...";

                // 5. Enable Pages
                await octokit.request('POST /repos/{owner}/{repo}/pages', {
                    owner: githubUser,
                    repo: siteName,
                    source: { branch: 'main', path: '/' }
                });

                document.getElementById('loader').style.display = 'none';
                alert(`ðŸš€ SUCCESS! Your site is live at: https://${githubUser}.github.io/${siteName}/`);

            } catch (error) {
                document.getElementById('loader').style.display = 'none';
                console.error("Full Error Object:", error);
                
                if (error.status === 403 || error.message.includes('Resource not accessible')) {
                    alert("STILL BLOCKED: GitHub is not giving this session 'repo' access. \n\n1. Go to GitHub Settings > Applications and REVOKE 'web-maker'. \n2. Click 'Sign Out' in this app. \n3. Sign in again and check the REPO box.");
                } else if (error.status === 422) {
                    alert("Error: A repository with this name already exists on your GitHub!");
                } else {
                    alert("Error: " + error.message);
                }
            }
        };

        window.downloadSite = function() {
            const html = editor.getHtml();
            const css = editor.getCss();
            const blob = new Blob([`<html><style>${css}</style><body>${html}</body></html>`], {type: "text/html"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "index.html";
            a.click();
        };
    </script>
</body>
</html>
