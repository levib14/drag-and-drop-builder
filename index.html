<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenBuilder Enterprise</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background: #111; }
        
        /* Professional Dark Theme Overrides */
        .gjs-one-bg { background-color: #0f0f0f !important; }
        .gjs-two-bg { background-color: #1a1a1a !important; }
        .gjs-three-bg { background-color: #222 !important; }
        .gjs-four-color { color: #ffffff !important; }
        .gjs-four-color-h:hover { color: #3b82f6 !important; }
        .gjs-pn-buttons { background-color: #0f0f0f !important; border-bottom: 1px solid #222 !important; }
        
        /* Page Manager UI */
        #page-manager-container {
            position: absolute; top: 40px; left: 0; width: 200px; height: auto;
            background: #1a1a1a; z-index: 100; border: 1px solid #333; display: none; padding: 10px;
        }
        .page-item { padding: 8px; color: #ccc; cursor: pointer; border-bottom: 1px solid #333; font-size: 12px; }
        .page-item:hover { background: #333; color: white; }
    </style>
</head>
<body>

    <div id="page-manager-container">
        <div style="font-size: 10px; color: #555; text-transform: uppercase; margin-bottom: 10px;">Page Manager</div>
        <div id="page-list"></div>
        <button onclick="addNewPage()" style="width: 100%; margin-top: 10px; background: #333; color: white; border: none; padding: 5px; cursor: pointer;">+ Add Page</button>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            fromElement: true,
            storageManager: false,
            allowScripts: 1,
            pageManager: true, // Native Page Management enabled
            canvas: { styles: ['https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap'] },
            blockManager: {
                blocks: [
                    {
                        id: 'section-pro', label: 'Section', category: 'Layout',
                        content: `<section style="padding:100px 20px; display:flex; flex-direction:column; align-items:center; background:#000;">
                                    <h1 style="color:#fff; font-size:40px;">New Headline</h1>
                                    <p style="color:#888;">Design your future here.</p>
                                  </section>`
                    },
                    {
                        id: 'free-move', label: 'Free Box', category: 'Advanced',
                        content: {
                            style: { position: 'absolute', top: '100px', left: '100px', padding: '30px', background: '#3b82f6', width: '200px', color: '#fff' },
                            content: 'Drag me anywhere'
                        }
                    },
                    {
                        id: 'embed-pro', label: 'Embed Box', category: 'Advanced',
                        content: {
                            type: 'default',
                            content: '<div style="padding:20px; border:2px dashed #444; text-align:center; color:#666;">Paste HTML/JS in Settings (Gear Icon)</div>',
                            traits: [{ type: 'textarea', label: 'Custom Code', name: 'custom-code' }]
                        }
                    }
                ]
            }
        });

        const pm = editor.Pages;
        const pn = editor.Panels;

        // 1. ADD NATIVE BUTTONS TO HEADER
        pn.addButton('options', [
            {
                id: 'pages-toggle', className: 'fa fa-file-code',
                command: () => {
                    const el = document.getElementById('page-manager-container');
                    el.style.display = el.style.display === 'none' ? 'block' : 'none';
                    updatePageList();
                },
                attributes: { title: 'Manage Pages' }
            },
            { id: 'undo', className: 'fa fa-undo', command: e => e.UndoManager.undo() },
            { id: 'redo', className: 'fa fa-repeat', command: e => e.UndoManager.redo() },
            { id: 'export-zip', className: 'fa fa-download', command: () => exportToZip() },
            { id: 'publish', className: 'fa fa-cloud-upload', command: () => publishToGithub() }
        ]);

        // 2. PAGE MANAGER LOGIC
        window.addNewPage = () => {
            const name = prompt("Page name (e.g., about, contact):");
            if (name) {
                pm.add({ id: name, component: `<section style="padding:100px; text-align:center;"><h1>Welcome to ${name}</h1></section>` });
                updatePageList();
            }
        };

        const updatePageList = () => {
            const list = document.getElementById('page-list');
            list.innerHTML = '';
            pm.getAll().forEach(page => {
                const div = document.createElement('div');
                div.className = 'page-item';
                div.innerHTML = `${page.get('id')} ${page.get('id') === pm.getSelected().get('id') ? '<b>(active)</b>' : ''}`;
                div.onclick = () => {
                    pm.select(page.get('id'));
                    updatePageList();
                };
                list.appendChild(div);
            });
        };

        // 3. GITHUB & CLOUD LOGIC
        let githubToken = "", githubUser = "";
        const publishToGithub = async () => {
            if (!githubToken) {
                const provider = new firebase.auth.GithubAuthProvider();
                provider.addScope('repo');
                const result = await firebase.auth().signInWithPopup(provider);
                githubToken = result.credential.accessToken;
                githubUser = result.additionalUserInfo.username;
            }
            
            const repoName = prompt("GitHub Repository Name:");
            if (!repoName) return;
            
            const octo = new Octokit({ auth: githubToken });
            const pages = pm.getAll();
            
            try {
                try { await octo.request('POST /user/repos', { name: repoName, auto_init: true }); } catch(e) {}
                
                // Save every page to the repo
                for (const page of pages) {
                    pm.select(page.get('id'));
                    const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
                    const filename = page.get('id') === 'index' ? 'index.html' : `${page.get('id')}.html`;
                    
                    await uploadFile(octo, repoName, filename, html);
                }
                alert("Multi-page site published successfully!");
            } catch (e) { alert(e.message); }
        };

        async function uploadFile(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); sha = res.data.sha; } catch(e) {}
            return octo.repos.createOrUpdateFileContents({ owner: githubUser, repo: repo, path: path, message: 'Sync', content: btoa(unescape(encodeURIComponent(content))), sha });
        }

        const exportToZip = async () => {
            const zip = new JSZip();
            pm.getAll().forEach(page => {
                pm.select(page.get('id'));
                const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
                const filename = page.get('id') === 'index' ? 'index.html' : `${page.get('id')}.html`;
                zip.file(filename, html);
            });
            const blob = await zip.generateAsync({ type: "blob" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "full_project.zip";
            link.click();
        };

        editor.on('load', () => {
            if (!pm.getSelected()) pm.add({ id: 'index', component: '<section style="padding:100px; text-align:center;"><h1>Index Page</h1></section>' });
        });
    </script>
</body>
</html>
