<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder | Sign In & Publish</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; overflow: hidden; background: #1e1e1e; }
        .panel__top { 
            padding: 10px 20px; 
            background: #1e1e1e; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .btns-right { display: flex; gap: 10px; align-items: center; }
        #site-name {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            outline: none;
            width: 180px;
        }
        button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-github { background: #2ea44f; color: white; }
        .btn-github:hover { background: #2c974b; }
        
        /* Success Message Styling */
        #status-display {
            font-size: 13px;
            margin-right: 15px;
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .success-text { color: #2ea44f; font-weight: bold; }
        .error-text { color: #ff4d4d; }
        .success-link { color: #58a6ff; text-decoration: none; margin-left: 5px; border-bottom: 1px solid transparent; }
        .success-link:hover { border-bottom: 1px solid #58a6ff; }

        #gjs { height: calc(100vh - 56px) !important; }
        
        #loader {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            color: white;
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>

    <div id="loader">
        <h1 id="loader-title">Pushing to GitHub...</h1>
        <p id="loader-status">Preparing...</p>
    </div>

    <div class="panel__top">
        <div class="logo"><b>OpenBuilder</b></div>
        
        <div class="btns-right">
            <div id="status-display"></div>
            
            <input type="text" id="site-name" placeholder="Site Name">
            <button class="btn-github" onclick="loginAndPublish()">üöÄ Publish Site</button>
            <button style="background:transparent; color:#888; font-size:11px;" onclick="firebase.auth().signOut()">Sign Out</button>
        </div>
    </div>

    <div id="gjs">
        <section style="padding: 100px 50px; text-align: center; background-color: #f9f9f9;">
            <h1>OpenBuilder E-Commerce</h1>
            <p>Edit this site and hit Publish. Your link will appear at the top.</p>
        </section>
    </div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = {
            apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ",
            authDomain: "web-maker-c6261.firebaseapp.com",
            projectId: "web-maker-c6261"
        };
        
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            fromElement: true,
            height: '100%',
            storageManager: false,
            blockManager: {
                blocks: [
                    { id: 'text', label: 'Text', content: '<p>Edit me!</p>' },
                    { id: 'image', label: 'Image', content: { type: 'image' } }
                ]
            }
        });

        window.loginAndPublish = async function() {
            const statusBox = document.getElementById('status-display');
            const siteInput = document.getElementById('site-name');
            const siteName = siteInput.value.trim().replace(/\s+/g, '-').toLowerCase();
            
            if (!siteName) {
                statusBox.innerHTML = '<span class="error-text">‚ö†Ô∏è Enter a site name</span>';
                return;
            }

            statusBox.innerHTML = '<span>Logging in...</span>';

            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo'); 
            // provider.setCustomParameters({ 'prompt': 'consent' }); // Optional: remove if you want it to remember you

            try {
                const result = await firebase.auth().signInWithPopup(provider);
                const token = result.credential.accessToken;
                const githubUser = result.additionalUserInfo.username;

                document.getElementById('loader').style.display = 'flex';
                const octokit = new Octokit({ auth: token });

                // 1. SILENT NAME CHECK
                document.getElementById('loader-status').innerText = "Checking if name is taken...";
                try {
                    await octokit.repos.get({ owner: githubUser, repo: siteName });
                    // If we get here, it means the repo EXISTS
                    document.getElementById('loader').style.display = 'none';
                    statusBox.innerHTML = `<span class="error-text">‚ùå "${siteName}" already exists!</span>`;
                    return;
                } catch (e) {
                    if (e.status !== 404) throw e; // Only 404 is good (means name is free)
                }

                // 2. CREATE REPO
                document.getElementById('loader-status').innerText = "Creating repository...";
                await octokit.request('POST /user/repos', { name: siteName, auto_init: true });

                // 3. UPLOAD CONTENT
                await new Promise(r => setTimeout(r, 2000));
                document.getElementById('loader-status').innerText = "Uploading files...";
                const finalCode = `<!DOCTYPE html><html><style>${editor.getCss()}</style><body>${editor.getHtml()}</body></html>`;

                await octokit.repos.createOrUpdateFileContents({
                    owner: githubUser,
                    repo: siteName,
                    path: 'index.html',
                    message: 'Deploy',
                    content: btoa(unescape(encodeURIComponent(finalCode)))
                });

                // 4. ACTIVATE PAGES
                document.getElementById('loader-status').innerText = "Going live...";
                await octokit.request('POST /repos/{owner}/{repo}/pages', {
                    owner: githubUser,
                    repo: siteName,
                    source: { branch: 'main', path: '/' }
                });

                // 5. SUCCESS UI
                document.getElementById('loader').style.display = 'none';
                const liveUrl = `https://${githubUser}.github.io/${siteName}/`;
                statusBox.innerHTML = `
                    <span class="success-text">üöÄ Published!</span>
                    <a href="${liveUrl}" target="_blank" class="success-link">View Site</a>
                `;

            } catch (error) {
                document.getElementById('loader').style.display = 'none';
                console.error(error);
                statusBox.innerHTML = `<span class="error-text">‚ùå Error: ${error.status || 'Failed'}</span>`;
            }
        };
    </script>
</body>
</html>
