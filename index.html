<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder | Pro Creator</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root { --bg: #111; --panel: #1a1a1a; --border: #333; --accent: #3b82f6; --text: #efefef; }
        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* Premium Header UI */
        .app-header { 
            height: 55px; background: var(--panel); display: flex; 
            justify-content: space-between; align-items: center; 
            padding: 0 15px; border-bottom: 1px solid var(--border);
            z-index: 1001; position: relative;
        }

        .btn-group { display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        
        /* Sophisticated Button Styles */
        .btn { 
            background: #2a2a2a; color: #fff; border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;
            font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: #333; border-color: #555; }
        .btn-primary { background: var(--accent); border: none; }
        .btn-primary:hover { background: #2563eb; transform: scale(1.02); }

        /* Fixed Device Selector (No Clipping) */
        .device-selector {
            background: #111; color: white; border: 1px solid var(--border);
            padding: 7px 12px; border-radius: 6px; font-size: 13px; outline: none;
            cursor: pointer; min-width: 130px; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 10px;
        }

        /* Sidebar Drawer */
        #sync-panel {
            width: 0; position: fixed; left: 0; top: 55px; bottom: 0;
            background: var(--panel); border-right: 1px solid var(--border);
            transition: 0.35s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; overflow: hidden;
        }
        #sync-panel.open { width: 320px; padding: 25px; box-sizing: border-box; }

        input { background: #000; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }
        
        #gjs { height: calc(100vh - 55px) !important; }
        
        .global-style-section { margin-top: 25px; border-top: 1px solid var(--border); padding-top: 20px; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="btn-group">
            <button class="btn" onclick="toggleSync()"><span>‚öôÔ∏è</span> Settings</button>
            <button class="btn" onclick="exportToZip()"><span>üì¶</span> ZIP Export</button>
        </div>

        <div class="btn-group">
            <select class="device-selector" onchange="editor.setDevice(this.value)">
                <option value="Desktop">üñ•Ô∏è Desktop</option>
                <option value="Tablet">üì± Tablet</option>
                <option value="Mobile portrait">üì≤ Mobile</option>
            </select>
        </div>

        <div class="btn-group">
            <input type="text" id="site-name" placeholder="Project Name" style="width:150px;">
            <button class="btn btn-primary" onclick="publishSite()">üöÄ Publish</button>
        </div>
    </header>

    <div id="sync-panel">
        <h2 style="font-size:16px; margin:0 0 20px 0; color: var(--accent);">PROJECT CONTROL</h2>
        
        <button class="btn btn-primary" style="width:100%; justify-content:center; margin-bottom:15px;" id="auth-btn" onclick="connectGitHub()">Connect GitHub</button>
        
        <div id="repo-ui" style="display:none;">
            <select id="repo-list"></select>
            <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="importProject()">üìÇ Load Project</button>
        </div>

        <div class="global-style-section">
            <h3 style="font-size:12px; color:#888; text-transform:uppercase;">Global Styles</h3>
            <label style="font-size:11px; display:block; margin:10px 0 5px;">Brand Color</label>
            <input type="color" id="global-color" value="#3b82f6" onchange="updateGlobalStyle()">
            
            <label style="font-size:11px; display:block; margin:15px 0 5px;">Primary Font</label>
            <select id="global-font" onchange="updateGlobalStyle()" style="background:#000; color:white; width:100%; padding:8px; border-radius:6px; border:1px solid var(--border);">
                <option value="Inter, sans-serif">Inter (Modern)</option>
                <option value="'Playfair Display', serif">Playfair (Elegant)</option>
                <option value="'Roboto Mono', monospace">Roboto (Tech)</option>
                <option value="system-ui">System Default</option>
            </select>
        </div>

        <div style="margin-top:auto; padding-top:50px;">
            <button class="btn btn-flat" style="width:100%; justify-content:center; color:#ff4444;" onclick="resetCanvas()">Wipe Canvas</button>
        </div>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        // Initialize Firebase
        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            storageManager: false,
            canvas: { 
                styles: [
                    'https://fonts.googleapis.com/css2?family=Inter&family=Playfair+Display&family=Roboto+Mono&display=swap'
                ] 
            },
            deviceManager: {
                devices: [
                    { name: 'Desktop', width: '' },
                    { name: 'Tablet', width: '768px', widthMedia: '992px' },
                    { name: 'Mobile portrait', width: '320px', widthMedia: '480px' }
                ]
            },
            blockManager: {
                blocks: [
                    { id: 'section', label: 'Section', category: 'Layout', content: '<section style="padding:50px 0;"><h2>New Section</h2></section>' },
                    { id: 'grid-2', label: '2 Cols', category: 'Layout', content: '<div style="display:flex; flex-wrap:wrap; gap:20px; padding:20px;"><div style="flex:1; min-width:300px; min-height:100px; padding:20px; border:1px dashed #ccc;">Col 1</div><div style="flex:1; min-width:300px; min-height:100px; padding:20px; border:1px dashed #ccc;">Col 2</div></div>' },
                    { id: 'text', label: 'Text', category: 'Basic', content: '<div>Edit your text here</div>' },
                    { id: 'image', label: 'Image', category: 'Basic', content: { type: 'image' } },
                    { 
                        id: 'embed', 
                        label: '<b>Embed Code</b>', 
                        category: 'Advanced', 
                        content: {
                            type: 'default',
                            content: '<div style="padding:20px; border:1px dashed #666; text-align:center;">Custom Code Preview</div>',
                            traits: [{ type: 'textarea', label: 'Paste Code Here', name: 'custom-code' }]
                        }
                    }
                ]
            }
        });

        // Update Global Styles Logic
        window.updateGlobalStyle = () => {
            const color = document.getElementById('global-color').value;
            const font = document.getElementById('global-font').value;
            const css = `body { font-family: ${font} !important; color: ${color}; } h1, h2, h3 { color: ${color}; }`;
            editor.CssComposer.addRules(css);
        };

        // Export ZIP
        window.exportToZip = async () => {
            const zip = new JSZip();
            const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
            zip.file("index.html", html);
            zip.file("project-data.json", JSON.stringify(editor.getProjectData()));
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = (document.getElementById('site-name').value || "export") + ".zip";
            link.click();
        };

        // UI & GitHub Sync Logic (Consolidated)
        window.toggleSync = () => document.getElementById('sync-panel').classList.toggle('open');
        window.resetCanvas = () => confirm("Clear work?") && editor.DomComponents.clear();

        let githubToken = "", githubUser = "";
        window.connectGitHub = async () => {
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo');
            const result = await firebase.auth().signInWithPopup(provider);
            githubToken = result.credential.accessToken;
            githubUser = result.additionalUserInfo.username;
            document.getElementById('auth-btn').style.display = 'none';
            document.getElementById('repo-ui').style.display = 'block';
            fetchRepos();
        };

        async function fetchRepos() {
            const octo = new Octokit({ auth: githubToken });
            const repos = await octo.repos.listForAuthenticatedUser({ sort: 'updated' });
            document.getElementById('repo-list').innerHTML = repos.data.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
        }

        window.publishSite = async () => {
            const name = document.getElementById('site-name').value;
            if(!name || !githubToken) return alert("Setup Project Name/GitHub first");
            const octo = new Octokit({ auth: githubToken });
            const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
            try {
                try { await octo.request('POST /user/repos', { name: name, auto_init: true }); } catch(e){}
                await uploadFile(octo, name, 'project-data.json', JSON.stringify(editor.getProjectData()));
                await uploadFile(octo, name, 'index.html', html);
                alert("Site Published Successfully!");
            } catch(e) { alert(e.message); }
        };

        async function uploadFile(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); sha = res.data.sha; } catch (e) {}
            return octo.repos.createOrUpdateFileContents({ owner: githubUser, repo: repo, path: path, message: 'OpenBuilder Sync', content: btoa(unescape(encodeURIComponent(content))), sha });
        }

        window.importProject = async () => {
            const repo = document.getElementById('repo-list').value;
            const octo = new Octokit({ auth: githubToken });
            try {
                const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: 'project-data.json' });
                editor.loadProjectData(JSON.parse(atob(res.data.content)));
                document.getElementById('site-name').value = repo;
                toggleSync();
            } catch(e) { alert("Error loading project data."); }
        };
    </script>
</body>
</html>
