<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder | Integrated Suite</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: #222; color: white; overflow: hidden; }
        
        /* Top Toolbar */
        .toolbar { 
            height: 45px; background: #1a1a1a; display: flex; 
            justify-content: space-between; align-items: center; 
            padding: 0 15px; border-bottom: 1px solid #333; 
        }
        .device-view { display: flex; gap: 15px; }
        .device-view button { background: none; border: none; color: #888; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .device-view button:hover, .device-view button.active { color: #3b82f6; }

        /* Sync Drawer */
        #sync-drawer {
            position: fixed; left: -300px; top: 45px; bottom: 0; width: 300px;
            background: #1a1a1a; border-right: 1px solid #333; z-index: 100;
            transition: 0.3s; padding: 20px; box-sizing: border-box;
        }
        #sync-drawer.open { left: 0; }
        
        .drawer-toggle { 
            background: #333; color: #ccc; border: none; padding: 5px 10px; 
            border-radius: 4px; cursor: pointer; font-size: 12px;
        }

        input, select { background: #2a2a2a; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; width: 100%; margin-bottom: 10px; }
        .btn-pub { background: #22c55e; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        #gjs { height: calc(100vh - 45px) !important; }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="drawer-toggle" onclick="document.getElementById('sync-drawer').classList.toggle('open')">‚òÅÔ∏è Cloud Sync</button>
        
        <div class="device-view">
            <button onclick="setDevice('Desktop')" title="Desktop">üñ•Ô∏è</button>
            <button onclick="setDevice('Tablet')" title="Tablet">üì±</button>
            <button onclick="setDevice('Mobile portrait')" title="Mobile">üì≤</button>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="site-name" placeholder="Site Name" style="width:120px; margin:0; height:28px;">
            <button class="btn-pub" onclick="publishSite()">Publish</button>
        </div>
    </div>

    <div id="sync-drawer">
        <h3>GitHub Sync</h3>
        <button class="btn-pub" style="background:#444; width:100%;" id="auth-btn" onclick="connectGitHub()">Connect GitHub</button>
        <div id="repo-controls" style="display:none; margin-top:15px;">
            <select id="repo-list"><option>Loading...</option></select>
            <button class="btn-pub" style="background:#3b82f6; width:100%;" onclick="importProject()">Open Project</button>
            <button onclick="deleteCurrentProject()" style="color:#ef4444; background:none; border:none; margin-top:20px; cursor:pointer;">Delete Repository</button>
        </div>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        // Firebase Setup
        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        // 1. Initialize Editor with Custom PayPal Blocks
        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            storageManager: false,
            deviceManager: {
                devices: [
                    { name: 'Desktop', width: '' },
                    { name: 'Tablet', width: '768px', widthMedia: '992px' },
                    { name: 'Mobile portrait', width: '320px', widthMedia: '480px' }
                ]
            },
            blockManager: {
                blocks: [
                    { id: 'section', label: 'Section', category: 'Layout', content: '<section style="padding:50px; min-height:150px;"><h2>New Section</h2></section>' },
                    { id: 'text', label: 'Text', category: 'Basic', content: '<div>Edit this text</div>' },
                    { id: 'image', label: 'Image', category: 'Basic', content: { type: 'image' } },
                    { 
                        id: 'paypal-item', 
                        label: '<b>PayPal Product</b>', 
                        category: 'Commerce', 
                        content: { type: 'paypal-card' } 
                    }
                ]
            }
        });

        // 2. Define the Custom PayPal Component (with Trait settings)
        editor.DomComponents.addType('paypal-card', {
            model: {
                defaults: {
                    attributes: { class: 'paypal-container', 'data-price': '10.00', 'data-item': 'My Product' },
                    traits: [
                        { type: 'text', label: 'Product Name', name: 'data-item' },
                        { type: 'number', label: 'Price ($)', name: 'data-price' }
                    ],
                    components: `
                        <div style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#fff; color:#333; text-align:center; max-width:250px;">
                            <img src="https://via.placeholder.com/150" style="width:100%; border-radius:4px;"/>
                            <h3 class="p-name">My Product</h3>
                            <p style="font-weight:bold;">$<span class="p-price">10.00</span></p>
                            <div class="paypal-slot" style="background:#ffc439; padding:8px; border-radius:4px; font-weight:bold;">PayPal Button</div>
                        </div>`
                },
                init() {
                    this.on('change:attributes:data-item change:attributes:data-price', this.updateVisuals);
                },
                updateVisuals() {
                    const attr = this.getAttributes();
                    this.getEl().querySelector('.p-name').innerText = attr['data-item'];
                    this.getEl().querySelector('.p-price').innerText = attr['data-price'];
                }
            }
        });

        // 3. Toolbar Functions
        window.setDevice = (device) => editor.setDevice(device);

        // 4. GitHub & Publishing Logic (Simplified & Integrated)
        let githubToken = "", githubUser = "";
        window.connectGitHub = async () => {
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo').addScope('delete_repo');
            const result = await firebase.auth().signInWithPopup(provider);
            githubToken = result.credential.accessToken;
            githubUser = result.additionalUserInfo.username;
            document.getElementById('auth-btn').style.display = 'none';
            document.getElementById('repo-controls').style.display = 'block';
            fetchRepos();
        };

        async function fetchRepos() {
            const octo = new Octokit({ auth: githubToken });
            const repos = await octo.repos.listForAuthenticatedUser({ sort: 'updated' });
            document.getElementById('repo-list').innerHTML = repos.data.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
        }

        window.publishSite = async () => {
            const name = document.getElementById('site-name').value;
            if(!name || !githubToken) return alert("Connect GitHub & Enter Name!");
            const octo = new Octokit({ auth: githubToken });
            
            const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style>
                <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"><\/script></head>
                <body>${editor.getHtml()}
                <script>
                    document.querySelectorAll('.paypal-container').forEach(el => {
                        const price = el.getAttribute('data-price');
                        const item = el.getAttribute('data-item');
                        const slot = el.querySelector('.paypal-slot');
                        slot.innerHTML = '';
                        paypal.Buttons({
                            createOrder: (d, a) => a.order.create({ purchase_units: [{ description: item, amount: { value: price } }] })
                        }).render(slot);
                    });
                <\/script></body></html>`;

            try {
                try { await octo.request('POST /user/repos', { name: name, auto_init: true }); } catch (e) {}
                await uploadFile(octo, name, 'project-data.json', JSON.stringify(editor.getProjectData()));
                await uploadFile(octo, name, 'index.html', html);
                alert("Published Successfully!");
            } catch(e) { alert(e.message); }
        };

        async function uploadFile(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); sha = res.data.sha; } catch (e) {}
            return octo.repos.createOrUpdateFileContents({ owner: githubUser, repo: repo, path: path, message: 'Sync', content: btoa(unescape(encodeURIComponent(content))), sha });
        }

        window.importProject = async () => {
            const repo = document.getElementById('repo-list').value;
            const octo = new Octokit({ auth: githubToken });
            const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: 'project-data.json' });
            editor.loadProjectData(JSON.parse(atob(res.data.content)));
            document.getElementById('site-name').value = repo;
        };
    </script>
</body>
</html>
