<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenBuilder | Apex Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root { --bg: #080808; --panel: #111; --border: #222; --accent: #0070f3; --text: #fafafa; }
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* Fixed Pro Header */
        .app-header { 
            height: 60px; background: var(--panel); display: flex; 
            justify-content: space-between; align-items: center; 
            padding: 0 25px; border-bottom: 1px solid var(--border); z-index: 1001;
        }

        .btn { 
            background: transparent; color: #fff; border: 1px solid var(--border);
            padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 11px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
        }
        .btn:hover { background: #fff; color: #000; }
        .btn-primary { background: var(--accent); border: none; }

        /* Undo/Redo Group */
        .history-group { display: flex; border: 1px solid var(--border); border-radius: 5px; overflow: hidden; }
        .btn-hist { background: var(--panel); border: none; color: #fff; padding: 10px 15px; cursor: pointer; font-size: 12px; }
        .btn-hist:hover { background: #222; }

        #sync-panel {
            width: 0; position: fixed; left: 0; top: 60px; bottom: 0;
            background: var(--panel); border-right: 1px solid var(--border);
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; overflow: hidden;
        }
        #sync-panel.open { width: 340px; padding: 30px; box-sizing: border-box; }

        .device-selector {
            background: #000; color: #fff; border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 5px; font-size: 11px; font-weight: bold; cursor: pointer;
        }

        #gjs { height: calc(100vh - 60px) !important; }
        input, select { background: #000; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 5px; width: 100%; margin-bottom: 15px; }
        .label-cap { font-size: 10px; color: #555; text-transform: uppercase; margin-bottom: 8px; display: block; font-weight: bold; }
    </style>
</head>
<body>

    <header class="app-header">
        <div style="display:flex; gap:12px;">
            <button class="btn" onclick="toggleSync()">Settings</button>
            <div class="history-group">
                <button class="btn-hist" title="Undo" onclick="editor.UndoManager.undo()">⟲</button>
                <button class="btn-hist" title="Redo" onclick="editor.UndoManager.redo()">⟳</button>
            </div>
        </div>

        <select id="device-view" class="device-selector">
            <option value="Desktop">Desktop View</option>
            <option value="Tablet">Tablet View</option>
            <option value="Mobile portrait">Mobile View</option>
        </select>

        <div style="display:flex; gap:12px; align-items: center;">
            <input type="text" id="site-name" placeholder="PROJECT_ID" style="width:140px; margin:0; height:36px;">
            <button class="btn btn-primary" onclick="publishSite()">Publish Live</button>
        </div>
    </header>

    <div id="sync-panel">
        <span class="label-cap">Design System</span>
        <label class="label-cap">Brand Accent</label>
        <input type="color" id="global-color" value="#0070f3" onchange="applyGlobalStyles()">
        
        <label class="label-cap">Typography</label>
        <select id="global-font" onchange="applyGlobalStyles()">
            <option value="Inter, sans-serif">Modern Sans</option>
            <option value="Georgia, serif">Classic Serif</option>
        </select>

        <div style="margin-top:40px; border-top: 1px solid var(--border); padding-top:20px;">
            <span class="label-cap">Cloud Connectivity</span>
            <button class="btn" style="width:100%; margin-bottom:15px;" id="auth-btn" onclick="connectGitHub()">Connect GitHub</button>
            <div id="repo-ui" style="display:none;">
                <select id="repo-list"></select>
                <button class="btn btn-primary" style="width:100%" onclick="importProject()">Sync Project</button>
            </div>
            <button class="btn" style="width:100%; margin-top:15px;" onclick="exportToZip()">Download ZIP</button>
            <button class="btn" style="width:100%; margin-top:20px; color:#ff4444; border-color:#331111;" onclick="resetCanvas()">Hard Reset</button>
        </div>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        // Define editor globally before init
        window.editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            fromElement: true,
            storageManager: false,
            allowScripts: 1,
            undoManager: { trackSelection: false },
            canvas: { styles: ['https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap'] },
            blockManager: {
                blocks: [
                    { 
                        id: 'hero-pro', 
                        label: 'Pro Hero Section', 
                        category: 'Layout', 
                        content: `<section style="padding:100px 20px; text-align:center; background:#000; color:#fff;">
                                    <h1 style="font-size:48px;">Elevate Your Brand</h1>
                                    <p style="font-size:18px; color:#888;">The future of commerce is here.</p>
                                    <button style="background:#fff; color:#000; padding:15px 30px; border:none; border-radius:5px; font-weight:bold; margin-top:20px;">Shop Now</button>
                                  </section>` 
                    },
                    { 
                        id: 'free-move-img', 
                        label: 'Free Image', 
                        category: 'Basic', 
                        content: { type: 'image', style: { position: 'absolute', top: '10px', left: '10px', width: '250px', 'z-index': '10' } } 
                    },
                    { 
                        id: 'free-move-txt', 
                        label: 'Free Text', 
                        category: 'Basic', 
                        content: '<div style="position:absolute; top:100px; left:100px; padding:10px; color:#fff; z-index:11;">Professional Text Overlay</div>' 
                    },
                    { 
                        id: 'embed-box', 
                        label: 'Custom Code', 
                        category: 'Advanced', 
                        content: { type: 'script', content: '<div style="padding:20px; border:1px solid #333; color:#666;">Custom HTML/JS Container</div>' } 
                    }
                ]
            }
        });

        // Event Listener for Device Switch (fixes ReferenceError)
        document.getElementById('device-view').addEventListener('change', (e) => {
            window.editor.setDevice(e.target.value);
        });

        window.applyGlobalStyles = () => {
            const color = document.getElementById('global-color').value;
            const font = document.getElementById('global-font').value;
            window.editor.CssComposer.addRules(`
                body { font-family: ${font} !important; }
                h1, h2, h3, .accent { color: ${color} !important; }
            `);
        };

        window.toggleSync = () => document.getElementById('sync-panel').classList.toggle('open');
        window.resetCanvas = () => confirm("Wipe everything?") && window.editor.DomComponents.clear();

        // GitHub / Publish Logic
        let githubToken = "", githubUser = "";
        window.connectGitHub = async () => {
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo');
            const result = await firebase.auth().signInWithPopup(provider);
            githubToken = result.credential.accessToken;
            githubUser = result.additionalUserInfo.username;
            document.getElementById('auth-btn').style.display = 'none';
            document.getElementById('repo-ui').style.display = 'block';
            fetchRepos();
        };

        async function fetchRepos() {
            const octo = new Octokit({ auth: githubToken });
            const repos = await octo.repos.listForAuthenticatedUser({ sort: 'updated' });
            document.getElementById('repo-list').innerHTML = repos.data.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
        }

        window.publishSite = async () => {
            const name = document.getElementById('site-name').value;
            if(!name || !githubToken) return alert("Connect GitHub & Name Project");
            const octo = new Octokit({ auth: githubToken });
            const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>${window.editor.getCss()}</style></head><body>${window.editor.getHtml()}</body></html>`;
            try {
                try { await octo.request('POST /user/repos', { name: name, auto_init: true }); } catch(e){}
                await uploadToGithub(octo, name, 'project-data.json', JSON.stringify(window.editor.getProjectData()));
                await uploadToGithub(octo, name, 'index.html', html);
                alert("Site is now live!");
            } catch(e) { alert("Publication failed. Check repo name."); }
        };

        async function uploadToGithub(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); sha = res.data.sha; } catch(e){}
            return octo.repos.createOrUpdateFileContents({ owner: githubUser, repo: repo, path: path, message: 'Apex Build Sync', content: btoa(unescape(encodeURIComponent(content))), sha });
        }

        window.importProject = async () => {
            const repo = document.getElementById('repo-list').value;
            const octo = new Octokit({ auth: githubToken });
            const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: 'project-data.json' });
            window.editor.loadProjectData(JSON.parse(atob(res.data.content)));
            document.getElementById('site-name').value = repo;
            toggleSync();
        };

        window.exportToZip = async () => {
            const zip = new JSZip();
            zip.file("index.html", `<!DOCTYPE html><html><head><style>${window.editor.getCss()}</style></head><body>${window.editor.getHtml()}</body></html>`);
            const blob = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "apex_site.zip"; a.click();
        };
    </script>
</body>
</html>
