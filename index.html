<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder | Pro Suite</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: #111; color: white; overflow: hidden; }
        .app-header { padding: 10px 20px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 55px; }
        .main-container { display: flex; height: calc(100vh - 55px); }
        
        /* Sidebar Styles */
        .sidebar { width: 320px; background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; gap: 15px; }
        .sidebar-section { border-bottom: 1px solid #333; padding-bottom: 15px; }
        .sidebar h3 { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; cursor: pointer; display: flex; justify-content: space-between; }
        
        /* Collapsible Logic */
        .collapsible-content { display: none; margin-top: 10px; }
        .collapsible-content.active { display: block; }
        .arrow { transition: transform 0.2s; }
        .active-arrow { transform: rotate(90deg); }

        input, select { background: #2a2a2a; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 13px; margin-bottom: 10px; }
        
        .btn { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .btn-save { background: #22c55e; color: white; width: auto !important; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #ccc; }
        .btn-delete { color: #ef4444; background: none; font-size: 11px; margin-top: 10px; }

        #gjs { flex-grow: 1; }
        #popup-toast { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #f59e0b; color: #000; padding: 15px; border-radius: 8px; z-index: 3000; font-weight: bold; }
    </style>
</head>
<body>

    <div id="popup-toast">‚ö†Ô∏è <b>Pop-up Blocked?</b> Please allow pop-ups for GitHub login.</div>

    <header class="app-header">
        <div class="logo"><b>OpenBuilder</b></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="site-name" placeholder="Project Name" style="width:180px; margin:0;">
            <button class="btn btn-save" onclick="publishSite()">üöÄ Save & Publish</button>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            
            <div class="sidebar-section">
                <h3 onclick="toggleSection('cloud-tools', 'arr1')">Cloud Sync <span id="arr1" class="arrow">‚ñ∂</span></h3>
                <div id="cloud-tools" class="collapsible-content">
                    <select id="repo-list"><option>Connect to see projects</option></select>
                    <button class="btn btn-outline" id="auth-btn" onclick="connectGitHub()">üîë Connect GitHub</button>
                    <button class="btn btn-outline" id="load-btn" onclick="importProject()" style="display:none;">üìÇ Open Selected</button>
                    <button class="btn btn-delete" onclick="deleteCurrentProject()">Delete Repo</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 onclick="toggleSection('store-tools', 'arr2')">Store Settings <span id="arr2" class="arrow">‚ñ∂</span></h3>
                <div id="store-tools" class="collapsible-content active">
                    <input type="password" id="paypal-id" placeholder="PayPal Client ID">
                    <input type="color" id="global-color" value="#3b82f6" onchange="updateBrandColor(this.value)">
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Product Creator</h3>
                <input type="text" id="p-name" placeholder="Item Name">
                <input type="number" id="p-price" placeholder="Price">
                
                <label style="font-size:11px; color:#888;">Product Image</label>
                <input type="file" id="p-file" accept="image/*" style="padding:5px;">
                <input type="text" id="p-img" placeholder="Or Image URL">
                
                <button class="btn btn-blue" onclick="addNewProduct()">Add to Canvas</button>
            </div>

        </div>
        <div id="gjs"></div>
    </div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({ container: '#gjs', height: '100%', storageManager: false });
        
        // --- UI HELPERS ---
        window.toggleSection = (id, arrowId) => {
            const content = document.getElementById(id);
            const arrow = document.getElementById(arrowId);
            content.classList.toggle('active');
            arrow.classList.toggle('active-arrow');
        };

        // --- IMAGE UPLOAD LOGIC ---
        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            // Using a free ImgBB API Key (publicly available demo key)
            const response = await fetch('https://api.imgbb.com/1/upload?key=67015b3e214d0f735d4f3e7920f01e7e', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            return data.data.url;
        }

        window.addNewProduct = async () => {
            const btn = event.target;
            btn.innerText = "Uploading...";
            btn.disabled = true;

            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const color = document.getElementById('global-color').value;
            let imgUrl = document.getElementById('p-img').value;
            const fileInput = document.getElementById('p-file');

            if (fileInput.files[0]) {
                try { imgUrl = await uploadImage(fileInput.files[0]); } catch(e) { alert("Upload failed"); }
            }

            if(!imgUrl) imgUrl = 'https://via.placeholder.com/300';

            editor.addComponents(`<div class="product-card paypal-container" data-item="${name}" data-price="${price}" style="max-width:300px; margin:20px auto; background:white; color:#111; border-radius:12px; overflow:hidden; box-shadow:0 10px 25px rgba(0,0,0,0.1); font-family:sans-serif;"><img src="${imgUrl}" style="width:100%; height:200px; object-fit:cover;"/><div style="padding:20px; text-align:center;"><h3 style="margin:0;">${name}</h3><p style="font-weight:bold; color:${color}; font-size:1.3rem; margin:10px 0;">$${price}</p><div class="paypal-slot" style="background:${color}; color:white; padding:12px; border-radius:6px; font-weight:bold;">Checkout</div></div></div>`);
            
            btn.innerText = "Add to Canvas";
            btn.disabled = false;
        };

        // --- GITHUB & SYNC LOGIC ---
        let githubToken = "", githubUser = "";
        window.connectGitHub = async () => {
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo').addScope('delete_repo');
            try {
                const result = await firebase.auth().signInWithPopup(provider);
                githubToken = result.credential.accessToken;
                githubUser = result.additionalUserInfo.username;
                document.getElementById('auth-btn').style.display = 'none';
                document.getElementById('load-btn').style.display = 'block';
                fetchRepos();
            } catch (e) { alert("Popup blocked or login failed."); }
        };

        async function fetchRepos() {
            const octo = new Octokit({ auth: githubToken });
            const repos = await octo.repos.listForAuthenticatedUser({ sort: 'updated', per_page: 50 });
            document.getElementById('repo-list').innerHTML = repos.data.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
        }

        window.publishSite = async () => {
            const name = document.getElementById('site-name').value;
            const ppId = document.getElementById('paypal-id').value || 'sb';
            if(!name || !githubToken) return alert("Setup name/GitHub first!");

            const octo = new Octokit({ auth: githubToken });
            const secretKey = btoa(ppId);
            const ghost = `(function(){const _k=atob("${secretKey}");const s=document.createElement('script');s.src="https://www.paypal.com/sdk/js?client-id="+_k+"&currency=USD";s.onload=()=>{document.querySelectorAll('.paypal-container').forEach(el=>{const p=el.getAttribute('data-price'),i=el.getAttribute('data-item'),slot=el.querySelector('.paypal-slot');if(!slot)return;slot.innerHTML='';paypal.Buttons({createOrder:(data,actions)=>actions.order.create({purchase_units:[{description:i,amount:{value:p}}]})}).render(slot);});};document.head.appendChild(s);})();`;
            const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style></head><body>${editor.getHtml()}<script>${ghost}<\/script></body></html>`;

            try {
                try { await octo.request('POST /user/repos', { name: name, auto_init: true }); } catch (e) {}
                await uploadFile(octo, name, 'project-data.json', JSON.stringify(editor.getProjectData()));
                await uploadFile(octo, name, 'index.html', html);
                await octo.request('POST /repos/{owner}/{repo}/pages', { owner: githubUser, repo: name, source: { branch: 'main', path: '/' } }).catch(e=>{});
                alert("Site Published!");
            } catch(e) { alert(e.message); }
        };

        async function uploadFile(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); sha = res.data.sha; } catch (e) {}
            return octo.repos.createOrUpdateFileContents({ owner: githubUser, repo: repo, path: path, message: 'Sync', content: btoa(unescape(encodeURIComponent(content))), sha });
        }
        
        window.importProject = async () => {
            const repo = document.getElementById('repo-list').value;
            const octo = new Octokit({ auth: githubToken });
            try {
                const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: 'project-data.json' });
                editor.loadProjectData(JSON.parse(atob(res.data.content)));
                document.getElementById('site-name').value = repo;
            } catch(e) { alert("No project data found."); }
        };

        window.deleteCurrentProject = async () => {
            const repo = document.getElementById('site-name').value;
            if(!repo || !confirm("Delete " + repo + "?")) return;
            const octo = new Octokit({ auth: githubToken });
            await octo.repos.delete({ owner: githubUser, repo: repo });
            location.reload();
        };

        window.updateBrandColor = (c) => {
            editor.DomComponents.getWrapper().find('.paypal-slot').forEach(s => s.addStyle({ background: c }));
        };
    </script>
</body>
</html>
