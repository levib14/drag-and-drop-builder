<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenBuilder | Pro Suite</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root { --accent: #3b82f6; --bg: #0a0a0a; --panel: #141414; --input: #2a2a2a; --text: #ffffff; }
        body, html { height: 100%; margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; }
        
        /* HIGH CONTRAST THEME FOR INPUTS */
        .gjs-one-bg { background-color: var(--bg) !important; }
        .gjs-two-bg { background-color: var(--panel) !important; }
        .gjs-three-bg { background-color: #1e1e1e !important; }
        .gjs-field, .gjs-sm-field, .gjs-clm-field, select, input, textarea { 
            background-color: var(--input) !important; 
            color: #ffffff !important; 
            border: 1px solid #444 !important;
            padding: 5px !important;
        }
        .gjs-sm-label, .gjs-label { color: #ccc !important; font-weight: 500 !important; }
        .gjs-four-color { color: var(--accent) !important; }

        /* Notification Toast */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #111; border: 1px solid var(--accent); color: white;
            padding: 15px 30px; border-radius: 4px; font-size: 12px; font-weight: bold;
            display: none; z-index: 10001; box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        }

        /* Sidebar UI */
        #sidebar {
            position: absolute; top: 40px; left: 0; width: 280px; bottom: 0;
            background: #0d0d0d; border-right: 1px solid #222; z-index: 1005; 
            display: none; padding: 25px; box-sizing: border-box; overflow-y: auto;
        }
        .nav-item { 
            padding: 12px; color: #777; cursor: pointer; border-radius: 4px;
            margin-bottom: 5px; font-size: 12px; display: flex; justify-content: space-between; border: 1px solid transparent;
        }
        .nav-item:hover { border-color: #333; color: #fff; }
        .nav-item.active { background: #1a1a1a; color: var(--accent); font-weight: bold; border-color: var(--accent); }
        
        .sidebar-label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1.5px; margin: 25px 0 10px; display: block; }
        .sidebar-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="toast">Ready</div>

    <div id="sidebar">
        <span class="sidebar-label">Project Control</span>
        <input type="text" id="repo-name" class="sidebar-input" placeholder="Repository Name">
        <button onclick="importProject()" style="width:100%; background:#222; color:#fff; border:1px solid #444; padding:10px; cursor:pointer; font-weight:bold; font-size:10px; border-radius:4px;">‚Üì IMPORT SAVED DATA</button>

        <span class="sidebar-label">Pages</span>
        <div id="page-list"></div>
        <button onclick="createNewPage()" style="width: 100%; margin-top: 15px; background: #fff; color: #000; border: none; padding: 12px; cursor: pointer; font-weight: 800; border-radius: 4px; font-size: 10px;">+ NEW PAGE</button>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            storageManager: false,
            pageManager: true,
            allowScripts: 1,
            canvas: { styles: ['https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap'] },
            blockManager: {
                blocks: [
                    { id: 'txt', label: 'Text', category: 'Basic', content: { type: 'text', content: 'Edit me', style: { position: 'absolute', top: '50px', left: '50px', color: '#fff' } } },
                    { id: 'img', label: 'Image', category: 'Basic', content: { type: 'image', style: { position: 'absolute', top: '100px', left: '100px', width: '250px' } } },
                    { id: 'btn', label: 'Link', category: 'Basic', content: { tagName: 'a', content: 'Explore', style: { position: 'absolute', top: '200px', left: '100px', padding: '10px 20px', background: '#3b82f6', color: '#fff', 'text-decoration': 'none', 'border-radius': '4px' }, traits: ['href'] } }
                ]
            }
        });

        const pm = editor.Pages;
        const pn = editor.Panels;

        window.notify = (msg, persist = false) => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            if(!persist) setTimeout(() => t.style.display = 'none', 4000);
        };

        pn.addButton('options', [
            { id: 'sidebar-tgl', className: 'fa fa-bars', command: () => { const s = document.getElementById('sidebar'); s.style.display = s.style.display === 'none' ? 'block' : 'none'; refreshUI(); } },
            { id: 'undo', className: 'fa fa-undo', command: 'core:undo' },
            { id: 'redo', className: 'fa fa-repeat', command: 'core:redo' },
            { id: 'deploy', className: 'fa fa-rocket', command: () => pushToGitHub() }
        ]);

        window.createNewPage = () => {
            const name = prompt("Page Name:");
            if (name) { pm.add({ id: name, component: `<div style="height:100vh; background:#000; position:relative;"><h1>${name} Page</h1></div>` }); refreshUI(); }
        };

        const refreshUI = () => {
            const list = document.getElementById('page-list'); list.innerHTML = '';
            pm.getAll().forEach(page => {
                const item = document.createElement('div');
                item.className = `nav-item ${page.id === pm.getSelected().id ? 'active' : ''}`;
                item.innerHTML = `<span>${page.id}.html</span>`;
                item.onclick = () => { pm.select(page.id); refreshUI(); };
                list.appendChild(item);
            });
        };

        let token = "", user = "";

        const pushToGitHub = async () => {
            const repo = document.getElementById('repo-name').value;
            if (!repo) return notify("‚ö†Ô∏è Enter Repository Name!");

            notify("üöÄ Uploading to GitHub...", true);

            if (!token) {
                const result = await firebase.auth().signInWithPopup(new firebase.auth.GithubAuthProvider());
                token = result.credential.accessToken;
                user = result.additionalUserInfo.username;
            }

            const octo = new Octokit({ auth: token });
            try {
                try { await octo.request('POST /user/repos', { name: repo, auto_init: true }); } catch(e) {}

                // 1. Save Project JSON
                await sync(octo, repo, 'project-data.json', JSON.stringify(editor.getProjectData()));

                // 2. Save Pages
                const all = pm.getAll();
                for (const p of all) {
                    pm.select(p.id);
                    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
                    const filename = (p.id === 'index' || all.indexOf(p) === 0) ? 'index.html' : `${p.id}.html`;
                    await sync(octo, repo, filename, html);
                }

                const liveUrl = `https://${user}.github.io/${repo}/`;
                pingSite(liveUrl);
            } catch (err) { notify("‚ùå Error: " + err.message); }
        };

        const pingSite = (url) => {
            notify("üõ∞Ô∏è Waiting for GitHub to build site...", true);
            const checker = setInterval(async () => {
                try {
                    const response = await fetch(url, { mode: 'no-cors' });
                    // Since GitHub returns 404 until it's ready, we clear when we get a hit
                    clearInterval(checker);
                    notify("‚úÖ SITE IS LIVE!");
                    window.open(url, '_blank');
                } catch (e) { /* Still 404/Building */ }
            }, 5000);
        };

        window.importProject = async () => {
            const repo = document.getElementById('repo-name').value;
            if (!repo) return notify("Enter Repo Name!");
            notify("üì• Importing data...", true);
            if (!token) { /* Sign in logic */ }
            const octo = new Octokit({ auth: token });
            try {
                const res = await octo.repos.getContent({ owner: user, repo: repo, path: 'project-data.json' });
                editor.loadProjectData(JSON.parse(atob(res.data.content)));
                notify("‚úÖ Import Success!");
                refreshUI();
            } catch (e) { notify("‚ö†Ô∏è Save-file not found."); }
        };

        async function sync(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: user, repo: repo, path: path }); sha = res.data.sha; } catch(e) {}
            return octo.repos.createOrUpdateFileContents({
                owner: user, repo: repo, path: path, message: 'Sync',
                content: btoa(unescape(encodeURIComponent(content))), sha: sha
            });
        }

        editor.on('load', () => { if (!pm.getSelected()) pm.add({ id: 'index', component: '<div style="height:100vh; background:#000; position:relative;"></div>' }); });
    </script>
</body>
</html>
