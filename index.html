<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder | Refined</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root { --panel-bg: #1e1e1e; --border: #333; --accent: #3b82f6; }
        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: #111; color: white; overflow: hidden; }
        
        /* Fixed Header */
        .app-header { 
            height: 50px; background: var(--panel-bg); display: flex; 
            justify-content: space-between; align-items: center; 
            padding: 0 15px; border-bottom: 1px solid var(--border);
            box-sizing: border-box;
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 12px; }

        /* The Styled Dropdown */
        .device-dropdown {
            background: #111; color: #ccc; border: 1px solid var(--border);
            padding: 5px 10px; border-radius: 4px; font-size: 13px;
            cursor: pointer; outline: none; width: 120px;
        }

        /* Sync Panel Drawer */
        #sync-panel {
            width: 0; position: fixed; left: 0; top: 50px; bottom: 0;
            background: var(--panel-bg); border-right: 1px solid var(--border);
            transition: 0.3s; z-index: 1000; overflow-x: hidden;
        }
        #sync-panel.open { width: 280px; padding: 20px; }

        .btn-toggle { background: var(--border); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #ef444422; color: #ef4444; border: 1px solid #ef444444; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; font-size: 12px; }

        input { background: #111; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; font-size: 13px; }
        #gjs { height: calc(100vh - 50px) !important; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-left">
            <button class="btn-toggle" onclick="toggleSync()">‚òÅÔ∏è Cloud Sync</button>
            <select class="device-dropdown" onchange="editor.setDevice(this.value)">
                <option value="Desktop">Desktop View</option>
                <option value="Tablet">Tablet View</option>
                <option value="Mobile portrait">Mobile View</option>
            </select>
        </div>

        <div class="header-right">
            <input type="text" id="site-name" placeholder="Project Name" style="width:140px;">
            <button class="btn-main" onclick="publishSite()">Publish</button>
        </div>
    </header>

    <div id="sync-panel">
        <h3 style="font-size:12px; color:#666; text-transform:uppercase;">Cloud Management</h3>
        <button class="btn-main" style="width:100%" id="auth-btn" onclick="connectGitHub()">Connect GitHub</button>
        
        <div id="repo-ui" style="display:none; margin-top:15px;">
            <select id="repo-list" style="width:100%; background:#111; color:white; border:1px solid #333; padding:8px; border-radius:4px; margin-bottom:10px;"></select>
            <button class="btn-main" style="width:100%" onclick="importProject()">üìÇ Load Project</button>
            
            <div style="margin-top:30px; border-top:1px solid #333; padding-top:15px;">
                <button class="btn-toggle" style="width:100%; margin-bottom:10px;" onclick="resetCanvas()">‚ú® Fresh Start (Clear All)</button>
                <button class="btn-danger" onclick="deleteCurrentProject()">‚ö†Ô∏è Delete Repository</button>
            </div>
        </div>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            storageManager: false,
            deviceManager: {
                devices: [
                    { name: 'Desktop', width: '' },
                    { name: 'Tablet', width: '768px', widthMedia: '992px' },
                    { name: 'Mobile portrait', width: '320px', widthMedia: '480px' }
                ]
            }
        });

        // UI Functions
        window.toggleSync = () => document.getElementById('sync-panel').classList.toggle('open');
        
        window.resetCanvas = () => {
            if(confirm("Clear everything and start a new project?")) {
                editor.DomComponents.clear();
                editor.CssComposer.clear();
                document.getElementById('site-name').value = '';
            }
        };

        // GitHub Logic (Integrated)
        let githubToken = "", githubUser = "";
        window.connectGitHub = async () => {
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo').addScope('delete_repo');
            const result = await firebase.auth().signInWithPopup(provider);
            githubToken = result.credential.accessToken;
            githubUser = result.additionalUserInfo.username;
            document.getElementById('auth-btn').style.display = 'none';
            document.getElementById('repo-ui').style.display = 'block';
            fetchRepos();
        };

        async function fetchRepos() {
            const octo = new Octokit({ auth: githubToken });
            const repos = await octo.repos.listForAuthenticatedUser({ sort: 'updated' });
            document.getElementById('repo-list').innerHTML = repos.data.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
        }

        window.importProject = async () => {
            const repo = document.getElementById('repo-list').value;
            const octo = new Octokit({ auth: githubToken });
            try {
                const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: 'project-data.json' });
                editor.loadProjectData(JSON.parse(atob(res.data.content)));
                document.getElementById('site-name').value = repo;
                toggleSync();
            } catch(e) {
                alert("Could not find project data in this repo.");
            }
        };

        window.publishSite = async () => {
            const name = document.getElementById('site-name').value;
            if(!name || !githubToken) return alert("Missing info!");
            const octo = new Octokit({ auth: githubToken });
            const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;

            try {
                try { await octo.request('POST /user/repos', { name: name, auto_init: true }); } catch (e) {}
                await uploadFile(octo, name, 'project-data.json', JSON.stringify(editor.getProjectData()));
                await uploadFile(octo, name, 'index.html', html);
                alert("Site Published!");
            } catch(e) { alert(e.message); }
        };

        async function uploadFile(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); sha = res.data.sha; } catch (e) {}
            return octo.repos.createOrUpdateFileContents({ owner: githubUser, repo: repo, path: path, message: 'Sync', content: btoa(unescape(encodeURIComponent(content))), sha });
        }

        window.deleteCurrentProject = async () => {
            const repo = document.getElementById('site-name').value;
            if(!repo || !confirm("Delete repo forever?")) return;
            const octo = new Octokit({ auth: githubToken });
            await octo.repos.delete({ owner: githubUser, repo: repo });
            location.reload();
        };
    </script>
</body>
</html>
