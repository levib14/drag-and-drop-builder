<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Apostle Eternal | The Ultimate Church Builder</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --bg: #050505; --panel: #111; --border: #222; --accent: #ffffff; }
        body, html { height: 100%; margin: 0; background: var(--bg); font-family: 'Inter', sans-serif; color: #fff; overflow: hidden; }

        /* ELITE LANDING UI */
        #landing-page {
            position: absolute; inset: 0; z-index: 2000; background: #000;
            display: flex; flex-direction: column; align-items: center; overflow-y: auto;
        }
        .nav-pro { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; padding: 40px; align-items: center; }
        .hero-title-eternal { font-size: clamp(60px, 15vw, 140px); font-weight: 900; letter-spacing: -8px; margin: 100px 0 10px 0; line-height: 0.8; text-align: center; background: linear-gradient(180deg, #fff 40%, #333 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .cta-container { display: flex; gap: 20px; margin-top: 50px; }
        .btn-eternal { background: #fff; color: #000; padding: 22px 60px; border-radius: 100px; font-weight: 900; border: none; cursor: pointer; font-size: 16px; transition: 0.3s cubic-bezier(0.2, 1, 0.3, 1); }
        .btn-eternal:hover { transform: scale(1.05); box-shadow: 0 0 50px rgba(255,255,255,0.2); }

        /* BUILDER INTERFACE */
        #builder-container { display: none; height: 100%; flex-direction: column; }
        #top-bar { height: 75px; background: #000; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 30px; gap: 25px; }
        
        /* Pro Tooling Skins */
        .gjs-cv-canvas { background-color: #0a0a0a !important; }
        .gjs-pn-views-container { background: #000 !important; border-left: 1px solid var(--border) !important; width: 320px !important; }
        .gjs-block { 
            background: #0f0f0f !important; border: 1px solid #1a1a1a !important; border-radius: 12px !important; 
            font-size: 10px !important; font-weight: bold !important; color: #888 !important; padding: 20px !important;
        }
        .gjs-block:hover { border-color: var(--gold) !important; color: #fff !important; }

        .ui-pill-group { display: flex; background: #111; border: 1px solid #222; border-radius: 50px; padding: 5px; }
        .ui-pill { padding: 10px 20px; border: none; background: none; color: #555; cursor: pointer; border-radius: 40px; font-size: 11px; font-weight: 800; }
        .ui-pill.active { background: #fff; color: #000; }

        #deploy-suite { margin-left: auto; display: flex; gap: 15px; }
        .repo-field { background: #111; border: 1px solid #222; color: #fff; padding: 12px 20px; border-radius: 12px; width: 250px; font-size: 13px; }

        /* DEVICE PREVIEW */
        .device-mobile .gjs-frame-wrapper { 
            width: 375px !important; height: 812px !important; margin: 50px auto !important; 
            border: 14px solid #1a1a1a !important; border-radius: 50px !important; box-shadow: 0 50px 100px rgba(0,0,0,1) !important;
        }

        #toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 20px 40px; border-radius: 100px; font-weight: 900; z-index: 10000; display: none; }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="nav-pro">
            <b style="color:var(--gold); letter-spacing: 5px; font-size: 14px;">APOSTLE ETERNAL</b>
            <div style="display:flex; gap:30px; font-size:11px; font-weight:800; color:#444; letter-spacing:1px;">
                <span>OPEN SOURCE</span><span>COMMUNITY</span><span>DOCUMENTATION</span>
            </div>
        </div>

        <h1 class="hero-title-eternal">Built for<br>the Mission.</h1>
        <p style="color:#555; text-align:center; max-width: 700px; font-size: 22px; line-height: 1.5; font-weight: 500;">Create a world-class presence for your ministry. No jank. No limits. Just pure, absolute design power.</p>
        
        <div class="cta-container">
            <button class="btn-eternal" onclick="launchBuilder()">LAUNCH BUILDER</button>
            <button style="background:transparent; border: 1px solid #333; color:#fff; padding:22px 50px; border-radius:100px; font-weight:bold; cursor:pointer;" onclick="launchBuilder()">RELOAD SAVED PROJECT</button>
        </div>
    </div>

    <div id="builder-container">
        <div id="top-bar">
            <b style="color:var(--gold); font-size: 14px; letter-spacing: 2px;">APOSTLE</b>
            
            <div id="tab-list" class="ui-pill-group"></div>
            <button onclick="addPage()" class="ui-pill" style="color:var(--gold)">+ NEW PAGE</button>

            <div class="ui-pill-group">
                <button class="ui-pill active" id="btn-desktop" onclick="setDevice('Desktop')">DESKTOP</button>
                <button class="ui-pill" id="btn-mobile" onclick="setDevice('Mobile')">MOBILE</button>
            </div>

            <div id="deploy-suite">
                <input type="text" id="repo-id" class="repo-field" placeholder="Repository Project Name">
                <button onclick="pushToGitHub()" style="background:#fff; color:#000; border:none; padding:12px 30px; border-radius:12px; font-weight:900; cursor:pointer; font-size:12px;">PUBLISH LIVE</button>
                <button onclick="importProject()" style="background:#111; color:#555; border:1px solid #222; padding:12px 20px; border-radius:12px; cursor:pointer; font-size:12px;">LOAD</button>
            </div>
        </div>
        <div id="gjs"></div>
    </div>

    <div id="toast">Ready</div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            dragMode: 'absolute',
            storageManager: false,
            pageManager: true,
            deviceManager: {
                devices: [{ name: 'Desktop', width: '' }, { name: 'Mobile', width: '375px', widthMedia: '480px' }]
            },
            canvas: { styles: ['https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;900&display=swap'] },
            blockManager: {
                blocks: [
                    { id: 'eternal-hero', label: 'Cinematic Hero', category: 'Elite Sections', content: `
                        <section style="position:absolute; top:0; left:0; width:100%; height:100vh; background:#000; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                            <img src="https://images.unsplash.com/photo-1544427928-c49cdfebf494?q=80&w=1500" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0.4;">
                            <div style="position:relative; text-align:center;">
                                <h1 style="font-family:Cinzel; font-size:100px; color:#fff; margin:0;">Faith First</h1>
                                <p style="font-family:Inter; color:var(--gold); letter-spacing:10px; font-weight:900;">WELCOME TO THE FAMILY</p>
                            </div>
                        </section>`
                    },
                    { id: 'live-oracle', label: 'Smart Live Alert', category: 'Ministry Tools', content: `
                        <div id="live-banner" style="position:absolute; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); border:1px solid var(--gold); padding:15px 40px; border-radius:100px; display:flex; align-items:center; gap:20px; font-family:Inter; color:#fff; z-index:1000;">
                            <div style="width:10px; height:10px; background:#ff0000; border-radius:50%; animation:pulse 1s infinite;"></div>
                            <span style="font-weight:900; font-size:13px;">LIVE SERVICE DETECTED</span>
                            <a href="#" style="background:#fff; color:#000; padding:8px 20px; border-radius:50px; text-decoration:none; font-size:11px; font-weight:900;">WATCH NOW</a>
                        </div>`
                    },
                    { id: 'staff-card', label: 'Leadership Profile', category: 'Elite Sections', content: `
                        <div style="position:absolute; top:100px; left:100px; width:280px; text-align:center; font-family:Inter;">
                            <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?q=80&w=400" style="width:150px; height:150px; border-radius:50%; object-fit:cover; border:3px solid var(--gold);">
                            <h3 style="color:#fff; margin:15px 0 5px 0;">Pastor David King</h3>
                            <p style="color:var(--gold); font-size:12px; font-weight:bold; letter-spacing:1px;">LEAD PASTOR</p>
                        </div>`
                    }
                ]
            }
        });

        const pm = editor.Pages;

        window.launchBuilder = () => {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('builder-container').style.display = 'flex';
            updateTabs();
        };

        window.setDevice = (device) => {
            editor.setDevice(device);
            const canvas = document.querySelector('.gjs-cv-canvas');
            if(device === 'Mobile') canvas.classList.add('device-mobile');
            else canvas.classList.remove('device-mobile');
            document.querySelectorAll('.ui-pill').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${device.toLowerCase()}`).classList.add('active');
        };

        window.notify = (msg, stay = false) => {
            const t = document.getElementById('toast');
            t.innerHTML = msg; t.style.display = 'block';
            if(!stay) setTimeout(() => t.style.display = 'none', 5000);
        };

        window.addPage = () => {
            const name = prompt("Page Name (lowercase, no spaces):");
            if(name) { pm.add({ id: name, component: '<div style="height:100vh; background:#000; position:relative;"></div>' }); updateTabs(); }
        };

        const updateTabs = () => {
            const list = document.getElementById('tab-list');
            list.innerHTML = '';
            pm.getAll().forEach(p => {
                const btn = document.createElement('button');
                btn.className = `ui-pill ${p.id === pm.getSelected().id ? 'active' : ''}`;
                btn.innerText = p.id.toUpperCase();
                btn.onclick = () => { pm.select(p.id); updateTabs(); };
                list.appendChild(btn);
            });
        };

        // THE ANTI-JANK ENGINE (Drop Protection & Absolute Force)
        editor.on('component:add', (model) => {
            const style = model.getStyle();
            const canvasWidth = editor.Canvas.getElement().offsetWidth;
            
            // Force absolute
            let newStyle = { ...style, position: 'absolute' };
            
            // Drop Guard: Prevent going off the right side
            const currentLeft = parseInt(style.left) || 100;
            const compWidth = parseInt(style.width) || 300;
            
            if (currentLeft + compWidth > canvasWidth) {
                newStyle.left = (canvasWidth - compWidth - 50) + 'px';
            }
            if (!style.top) newStyle.top = '100px';
            if (!style.left) newStyle.left = '100px';

            model.setStyle(newStyle);
        });

        let token = "", user = "";

        window.pushToGitHub = async () => {
            const repo = document.getElementById('repo-id').value;
            if(!repo) return notify("‚ö†Ô∏è Please name your project.");
            notify("üõ∞Ô∏è Synchronizing Eternal Files...", true);

            if(!token) {
                const provider = new firebase.auth.GithubAuthProvider();
                provider.addScope('repo');
                const res = await firebase.auth().signInWithPopup(provider);
                token = res.credential.accessToken;
                user = res.additionalUserInfo.username;
            }

            const octo = new Octokit({ auth: token });
            try {
                try { await octo.request('POST /user/repos', { name: repo, auto_init: true }); } catch(e){}
                await sync(octo, repo, 'project-data.json', JSON.stringify(editor.getProjectData()));

                const pages = pm.getAll();
                for (const p of pages) {
                    pm.select(p.id);
                    const html = `<!DOCTYPE html><html><head><title>${p.id}</title><meta charset="utf-8"><style>${editor.getCss()} body{background:#000; color:#fff; margin:0; overflow-x:hidden; position:relative; min-height:100vh; font-family:Inter, sans-serif;}</style></head><body>${editor.getHtml()}</body></html>`;
                    const filename = (p.id === 'index' || pages.indexOf(p) === 0) ? 'index.html' : `${p.id}.html`;
                    await sync(octo, repo, filename, html);
                }
                notify(`‚úÖ GLORY! PROJECT IS LIVE.<br><br><a href="https://github.com/${user}/${repo}" target="_blank">View Website Repository</a>`, true);
            } catch(e) { notify("‚ùå Error: " + e.message); }
        };

        window.importProject = async () => {
            const repo = document.getElementById('repo-id').value;
            if(!repo) return notify("‚ö†Ô∏è Enter project name.");
            notify("üì• Restoring Sanctuary...", true);
            if(!token) { /* Auth handled by push function */ }
            const octo = new Octokit({ auth: token });
            try {
                const res = await octo.repos.getContent({ owner: user, repo: repo, path: 'project-data.json' });
                editor.loadProjectData(JSON.parse(atob(res.data.content)));
                notify("‚úÖ Eternal Project Restored!");
                updateTabs();
            } catch(e) { notify("‚ö†Ô∏è No save data found."); }
        };

        async function sync(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: user, repo: repo, path: path }); sha = res.data.sha; } catch(e) {}
            return octo.repos.createOrUpdateFileContents({
                owner: user, repo: repo, path: path, message: 'Apostle Eternal Sync',
                content: btoa(unescape(encodeURIComponent(content))), sha: sha
            });
        }

        editor.on('load', () => {
            if(!pm.getSelected()) pm.add({ id: 'index', component: '<div style="height:100vh; background:#000; position:relative;"></div>' });
            updateTabs();
        });
    </script>
</body>
</html>
