<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder Titan</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root { --bg: #0a0a0a; --panel: #141414; --border: #262626; --accent: #ffffff; --text: #a3a3a3; }
        body, html { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* High-End Minimalist Header */
        .app-header { 
            height: 50px; background: var(--panel); display: flex; 
            justify-content: space-between; align-items: center; 
            padding: 0 20px; border-bottom: 1px solid var(--border);
            z-index: 1001;
        }

        .btn-group { display: flex; gap: 12px; align-items: center; }
        
        .btn { 
            background: transparent; color: #fff; border: 1px solid var(--border);
            padding: 7px 15px; border-radius: 4px; cursor: pointer; font-size: 12px;
            font-weight: 500; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn:hover { background: #fff; color: #000; }
        .btn-primary { background: #fff; color: #000; border: none; }

        .device-selector {
            background: #000; color: #fff; border: 1px solid var(--border);
            padding: 6px 10px; border-radius: 4px; font-size: 12px; outline: none;
            cursor: pointer; min-width: 120px;
        }

        /* Sidebar Drawer */
        #sync-panel {
            width: 0; position: fixed; left: 0; top: 50px; bottom: 0;
            background: var(--panel); border-right: 1px solid var(--border);
            transition: 0.3s ease-in-out; z-index: 1000; overflow: hidden;
        }
        #sync-panel.open { width: 300px; padding: 30px 20px; box-sizing: border-box; }

        input, select { background: #000; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 12px; margin-bottom: 15px; }
        
        #gjs { height: calc(100vh - 50px) !important; }
        
        .label-sm { font-size: 10px; text-transform: uppercase; color: #555; margin-bottom: 8px; display: block; font-weight: bold; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="btn-group">
            <button class="btn" onclick="toggleSync()">Settings</button>
            <button class="btn" onclick="exportToZip()">Export ZIP</button>
        </div>

        <div class="btn-group">
            <select class="device-selector" onchange="editor.setDevice(this.value)">
                <option value="Desktop">Desktop</option>
                <option value="Tablet">Tablet</option>
                <option value="Mobile portrait">Mobile</option>
            </select>
        </div>

        <div class="btn-group">
            <input type="text" id="site-name" placeholder="PROJECT_ID" style="width:140px; margin:0; height:32px;">
            <button class="btn btn-primary" onclick="publishSite()">Publish</button>
        </div>
    </header>

    <div id="sync-panel">
        <span class="label-sm">GitHub Connection</span>
        <button class="btn" style="width:100%; margin-bottom:20px;" id="auth-btn" onclick="connectGitHub()">Link Account</button>
        
        <div id="repo-ui" style="display:none;">
            <select id="repo-list"></select>
            <button class="btn btn-primary" style="width:100%" onclick="importProject()">Load Repository</button>
        </div>

        <div style="margin-top:30px; border-top: 1px solid var(--border); padding-top:20px;">
            <span class="label-sm">Global Theme</span>
            <label class="label-sm">Accent Color</label>
            <input type="color" id="global-color" value="#ffffff" onchange="updateGlobalStyle()">
            
            <label class="label-sm">Typography</label>
            <select id="global-font" onchange="updateGlobalStyle()">
                <option value="sans-serif">System Sans</option>
                <option value="serif">Classic Serif</option>
                <option value="monospace">Tech Mono</option>
            </select>
            
            <button class="btn" style="width:100%; margin-top:20px; color:#ff4444; border-color:#442222;" onclick="resetCanvas()">Clear All</button>
        </div>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            storageManager: false,
            allowScripts: 1, // Crucial for embeds
            deviceManager: {
                devices: [
                    { name: 'Desktop', width: '' },
                    { name: 'Tablet', width: '768px', widthMedia: '992px' },
                    { name: 'Mobile portrait', width: '320px', widthMedia: '480px' }
                ]
            },
            blockManager: {
                blocks: [
                    { id: 'section', label: 'Section', category: 'Layout', content: '<section style="padding:80px 20px; text-align:center;"><h2>Section Title</h2></section>' },
                    { id: 'column-2', label: '2 Columns', category: 'Layout', content: '<div style="display:flex; flex-wrap:wrap; gap:20px;"><div style="flex:1; min-width:300px; padding:20px;">Column A</div><div style="flex:1; min-width:300px; padding:20px;">Column B</div></div>' },
                    { id: 'text', label: 'Text', category: 'Basic', content: '<p>Enter text here...</p>' },
                    { id: 'image', label: 'Image', category: 'Basic', content: { type: 'image' } },
                    { 
                        id: 'custom-embed', 
                        label: 'Embed Code', 
                        category: 'Advanced', 
                        content: { type: 'custom-code-type' } 
                    }
                ]
            }
        });

        // RE-ENGINEERED EMBED COMPONENT
        editor.DomComponents.addType('custom-code-type', {
            model: {
                defaults: {
                    tagName: 'div',
                    attributes: { class: 'embed-wrapper' },
                    components: '<div style="padding:40px; background:#111; border:1px dashed #333; text-align:center;">Code Embed Area</div>',
                    traits: [{
                        type: 'textarea',
                        label: 'HTML/Script Code',
                        name: 'raw-html'
                    }]
                },
                init() {
                    this.on('change:attributes:raw-html', this.handleUpdate);
                },
                handleUpdate() {
                    const code = this.getAttributes()['raw-html'];
                    if(code) this.set('content', code);
                }
            }
        });

        window.updateGlobalStyle = () => {
            const color = document.getElementById('global-color').value;
            const font = document.getElementById('global-font').value;
            editor.CssComposer.addRules(`
                body { font-family: ${font} !important; }
                h1, h2, h3, p, div { color: ${color}; }
            `);
        };

        window.toggleSync = () => document.getElementById('sync-panel').classList.toggle('open');
        window.resetCanvas = () => confirm("Permanently clear canvas?") && editor.DomComponents.clear();

        // GitHub Logic
        let githubToken = "", githubUser = "";
        window.connectGitHub = async () => {
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo');
            const result = await firebase.auth().signInWithPopup(provider);
            githubToken = result.credential.accessToken;
            githubUser = result.additionalUserInfo.username;
            document.getElementById('auth-btn').style.display = 'none';
            document.getElementById('repo-ui').style.display = 'block';
            fetchRepos();
        };

        async function fetchRepos() {
            const octo = new Octokit({ auth: githubToken });
            const repos = await octo.repos.listForAuthenticatedUser({ sort: 'updated' });
            document.getElementById('repo-list').innerHTML = repos.data.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
        }

        window.publishSite = async () => {
            const name = document.getElementById('site-name').value;
            if(!name || !githubToken) return alert("Verify Project Name/GitHub connection");
            const octo = new Octokit({ auth: githubToken });
            const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
            try {
                try { await octo.request('POST /user/repos', { name: name, auto_init: true }); } catch(e){}
                await uploadFile(octo, name, 'project-data.json', JSON.stringify(editor.getProjectData()));
                await uploadFile(octo, name, 'index.html', html);
                alert("Cloud Sync Complete.");
            } catch(e) { alert(e.message); }
        };

        async function uploadFile(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); sha = res.data.sha; } catch (e) {}
            return octo.repos.createOrUpdateFileContents({ owner: githubUser, repo: repo, path: path, message: 'Titan Build Update', content: btoa(unescape(encodeURIComponent(content))), sha });
        }

        window.importProject = async () => {
            const repo = document.getElementById('repo-list').value;
            const octo = new Octokit({ auth: githubToken });
            try {
                const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: 'project-data.json' });
                editor.loadProjectData(JSON.parse(atob(res.data.content)));
                document.getElementById('site-name').value = repo;
                toggleSync();
            } catch(e) { alert("Format not compatible."); }
        };

        window.exportToZip = async () => {
            const zip = new JSZip();
            const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
            zip.file("index.html", html);
            zip.file("config.json", JSON.stringify(editor.getProjectData()));
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "titan_build.zip";
            link.click();
        };
    </script>
</body>
</html>
