<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenBuilder | Enterprise</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background: #0a0a0a; font-family: -apple-system, sans-serif; }
        
        /* Monochromatic Pro Theme */
        .gjs-one-bg { background-color: #0f0f0f !important; }
        .gjs-two-bg { background-color: #141414 !important; }
        .gjs-three-bg { background-color: #1a1a1a !important; }
        .gjs-four-color { color: #ffffff !important; }
        .gjs-pn-buttons { background-color: #0f0f0f !important; border-bottom: 1px solid #222 !important; }
        
        /* Unified Page Manager UI */
        #page-sidebar {
            position: absolute; top: 40px; left: 0; width: 240px; bottom: 0;
            background: #111; border-right: 1px solid #222; z-index: 1005; 
            display: none; padding: 20px; box-sizing: border-box;
        }
        .page-item { 
            padding: 12px; color: #888; cursor: pointer; border-radius: 4px;
            margin-bottom: 5px; font-size: 13px; display: flex; justify-content: space-between;
        }
        .page-item:hover { background: #1a1a1a; color: #fff; }
        .page-item.active { background: #222; color: #3b82f6; font-weight: 600; }
        
        .sidebar-label { font-size: 10px; color: #444; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; display: block; }
    </style>
</head>
<body>

    <div id="page-sidebar">
        <span class="sidebar-label">Project Pages</span>
        <div id="page-list"></div>
        <button onclick="addNewPage()" style="width: 100%; margin-top: 20px; background: #fff; color: #000; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 4px; font-size: 11px;">+ NEW PAGE</button>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        // Initialize Firebase
        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        window.editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            fromElement: true,
            storageManager: false,
            allowScripts: 1,
            pageManager: true,
            canvas: { 
                styles: [
                    'https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap'
                ] 
            },
            blockManager: {
                blocks: [
                    {
                        id: 'text', label: 'Text Block', category: 'Basic',
                        content: { type: 'text', content: 'Insert Text Here', style: { position: 'absolute', top: '50px', left: '50px', padding: '10px', color: '#fff' } }
                    },
                    {
                        id: 'image', label: 'Image', category: 'Basic',
                        content: { type: 'image', style: { position: 'absolute', top: '100px', left: '100px', width: '200px' } }
                    },
                    {
                        id: 'link-btn', label: 'Page Link Button', category: 'General',
                        content: { 
                            tagName: 'a', 
                            content: 'Click to Navigate', 
                            style: { position: 'absolute', top: '200px', left: '100px', padding: '12px 24px', background: '#3b82f6', color: '#fff', 'text-decoration': 'none', 'border-radius': '4px' },
                            traits: ['href', 'target'] 
                        }
                    },
                    {
                        id: 'code-embed', label: 'Custom Code', category: 'Advanced',
                        content: {
                            type: 'default',
                            content: '<div style="padding:20px; border:1px dashed #333; color:#444;">Custom Embed Content</div>',
                            traits: [{ type: 'textarea', label: 'HTML/Script', name: 'custom-code' }]
                        }
                    }
                ]
            }
        });

        const pm = window.editor.Pages;
        const pn = window.editor.Panels;

        // --- Integrated Header Buttons ---
        pn.addButton('options', [
            {
                id: 'open-pages', className: 'fa fa-copy',
                command: () => {
                    const sb = document.getElementById('page-sidebar');
                    sb.style.display = sb.style.display === 'none' ? 'block' : 'none';
                    refreshPageUI();
                },
                attributes: { title: 'Manage Site Pages' }
            },
            { id: 'undo', className: 'fa fa-undo', command: e => e.UndoManager.undo() },
            { id: 'redo', className: 'fa fa-repeat', command: e => e.UndoManager.redo() },
            { id: 'publish-btn', className: 'fa fa-rocket', command: () => pushToGitHub(), attributes: { title: 'Publish to GitHub Pages' } }
        ]);

        // --- Page Management Logic ---
        window.addNewPage = () => {
            const name = prompt("Enter page name (e.g., about, services):");
            if (name) {
                pm.add({ id: name, component: `<div style="height:100vh; background:#000; color:#fff; position:relative; padding:50px;"><h1>${name} Page</h1></div>` });
                refreshPageUI();
            }
        };

        const refreshPageUI = () => {
            const list = document.getElementById('page-list');
            list.innerHTML = '';
            pm.getAll().forEach(page => {
                const item = document.createElement('div');
                item.className = `page-item ${page.id === pm.getSelected().id ? 'active' : ''}`;
                item.innerHTML = `<span>${page.id}.html</span>`;
                item.onclick = () => { pm.select(page.id); refreshPageUI(); };
                list.appendChild(item);
            });
        };

        // --- Deployment Logic (GitHub Pages focus) ---
        let githubToken = "", githubUser = "";
        
        const pushToGitHub = async () => {
            if (!githubToken) {
                const provider = new firebase.auth.GithubAuthProvider();
                provider.addScope('repo');
                const result = await firebase.auth().signInWithPopup(provider);
                githubToken = result.credential.accessToken;
                githubUser = result.additionalUserInfo.username;
            }
            
            const repoName = prompt("Project ID / Repo Name:");
            if (!repoName) return;

            const octo = new Octokit({ auth: githubToken });
            
            try {
                // Ensure repo exists
                try { await octo.request('POST /user/repos', { name: repoName, auto_init: true }); } catch(e) {}

                const allPages = pm.getAll();
                for (const page of allPages) {
                    pm.select(page.id);
                    const htmlContent = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>${window.editor.getCss()}</style></head><body>${window.editor.getHtml()}</body></html>`;
                    
                    // CRITICAL: Ensure the main page is index.html for GitHub Pages compatibility
                    const finalFilename = (page.id === 'index' || allPages.length === 1) ? 'index.html' : `${page.id}.html`;
                    
                    await syncFile(octo, repoName, finalFilename, htmlContent);
                }
                alert(`Successfully deployed to ${githubUser}.github.io/${repoName}/`);
            } catch (err) { alert("Deployment Error: " + err.message); }
        };

        async function syncFile(octo, repo, path, content) {
            let sha = null;
            try { 
                const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); 
                sha = res.data.sha; 
            } catch (e) {}
            
            return octo.repos.createOrUpdateFileContents({
                owner: githubUser, repo: repo, path: path,
                message: 'OpenBuilder Sync',
                content: btoa(unescape(encodeURIComponent(content))),
                sha: sha
            });
        }

        window.editor.on('load', () => {
            if (!pm.getSelected()) {
                pm.add({ id: 'index', component: '<div style="height:100vh; background:#000; position:relative;"></div>' });
            }
        });
    </script>
</body>
</html>
