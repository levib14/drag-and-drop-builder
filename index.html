<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder Enterprise | Multi-Page Commerce</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: #1e1e1e; color: white; overflow: hidden; }
        .panel__top { padding: 10px 20px; background: #1e1e1e; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 60px; }
        .btns-right { display: flex; gap: 10px; align-items: center; }
        input, select { background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; font-size: 13px; }
        button { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; background: #444; color: white; transition: 0.3s; }
        .btn-github { background: #2ea44f; }
        .btn-add-page { background: #3b82f6; font-size: 11px; padding: 5px 10px; }
        #status-display { font-size: 12px; color: #888; }
        #gjs { height: calc(100vh - 60px) !important; }
        
        /* Layout for multi-page sidebar */
        .app-container { display: flex; height: calc(100vh - 60px); }
        .page-sidebar { width: 150px; background: #252525; border-right: 1px solid #333; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .page-item { padding: 8px; background: #333; border-radius: 4px; cursor: pointer; font-size: 12px; text-align: center; }
        .page-item.active { background: #3b82f6; }
    </style>
</head>
<body>

    <div class="panel__top">
        <div class="logo"><b>OpenBuilder</b> <small style="color:#3b82f6">Enterprise</small></div>
        <div class="btns-right">
            <div id="status-display">Ready</div>
            <input type="text" id="site-name" placeholder="Project Name...">
            <button class="btn-github" onclick="publishAllPages()">ðŸš€ Publish Entire Site</button>
        </div>
    </div>

    <div class="app-container">
        <div class="page-sidebar" id="page-list">
            <div style="font-size: 10px; color: #888; text-transform: uppercase;">Pages</div>
            <button class="btn-add-page" onclick="createNewPage()">+ New Page</button>
        </div>
        <div id="gjs" style="flex-grow: 1;"></div>
    </div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = {
            apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ",
            authDomain: "web-maker-c6261.firebaseapp.com",
            projectId: "web-maker-c6261"
        };
        firebase.initializeApp(firebaseConfig);

        // --- MULTI-PAGE STORAGE ---
        let sitePages = {
            'index.html': { 
                html: `<section style="padding:100px 20px; text-align:center; background:#f4f4f4; color:#333;">
                        <h1>Welcome to My Store</h1>
                        <p>Drag elements here to start building.</p>
                        <img src="https://via.placeholder.com/300" style="display:block; margin:20px auto; border-radius:10px;"/>
                       </section>`, 
                css: '' 
            }
        };
        let activePage = 'index.html';

        // --- INITIALIZE EDITOR ---
        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            fromElement: true,
            storageManager: false,
            canvas: { styles: ['https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css'] },
            blockManager: {
                blocks: [
                    { id: 'section', label: 'Section', category: 'Layout', content: '<section style="padding:50px; min-height:200px;"><h2>New Section</h2></section>' },
                    { id: 'text', label: 'Text', category: 'Basic', content: '<div style="padding:10px;">Edit this text</div>' },
                    { id: 'image', label: 'Image', category: 'Basic', content: { type: 'image', style: { width: '300px', height: 'auto', display: 'block', 'margin-left': 'auto', 'margin-right': 'auto' } } },
                    { id: 'paypal', label: '<b>PayPal Button</b>', category: 'Commerce', content: { type: 'paypal-button' } },
                    { id: 'contact', label: 'Contact Form', category: 'Forms', content: `
                        <form style="padding:20px; background:#fff; color:#333; border-radius:8px; max-width:400px; margin:auto;">
                            <input type="text" placeholder="Name" style="width:100%; margin-bottom:10px; padding:8px;"/>
                            <input type="email" placeholder="Email" style="width:100%; margin-bottom:10px; padding:8px;"/>
                            <textarea placeholder="Message" style="width:100%; margin-bottom:10px; padding:8px;"></textarea>
                            <button type="button" style="background:#3b82f6; color:white; width:100%; padding:10px;">Send Message</button>
                        </form>` 
                    }
                ]
            }
        });

        // Setup Component Types (PayPal)
        editor.DomComponents.addType('paypal-button', {
            model: {
                defaults: {
                    tagName: 'div',
                    attributes: { 'data-price': '49.99', 'data-item': 'Store Product', class: 'paypal-container' },
                    traits: [{ type: 'text', label: 'Name', name: 'data-item' }, { type: 'text', label: 'Price ($)', name: 'data-price' }],
                    components: `<div style="padding:20px; border:2px solid #ffc439; background:#fff; color:#111; text-align:center; border-radius:10px;">
                        <h3>Buy <span class="item-name">Store Product</span></h3>
                        <p>$<span class="item-price">49.99</span></p>
                        <div style="background:#ffc439; padding:10px; font-weight:bold;">PayPal Active on Live</div>
                    </div>`
                },
                init() { this.on('change:attributes:data-item change:attributes:data-price', this.updateContent); },
                updateContent() {
                    const attr = this.getAttributes();
                    this.getEl().querySelector('.item-name').innerText = attr['data-item'];
                    this.getEl().querySelector('.item-price').innerText = attr['data-price'];
                }
            }
        });

        // --- PAGE LOGIC ---
        window.renderPageList = () => {
            const list = document.getElementById('page-list');
            const items = Object.keys(sitePages).map(p => 
                `<div class="page-item ${p === activePage ? 'active' : ''}" onclick="switchPage('${p}')">${p}</div>`
            ).join('');
            list.innerHTML = `<div style="font-size: 10px; color: #888; text-transform: uppercase;">Pages</div>` + items + 
                            `<button class="btn-add-page" onclick="createNewPage()">+ New Page</button>`;
        };

        window.switchPage = (pageName) => {
            sitePages[activePage] = { html: editor.getHtml(), css: editor.getCss() };
            activePage = pageName;
            editor.setComponents(sitePages[pageName].html);
            editor.setStyle(sitePages[pageName].css);
            renderPageList();
        };

        window.createNewPage = () => {
            const name = prompt("Page name (e.g. about, shop):");
            if(name) {
                const filename = name.toLowerCase().replace(/\s+/g, '-') + '.html';
                sitePages[filename] = { html: '<h1>' + name + ' Page</h1>', css: '' };
                switchPage(filename);
            }
        };

        // --- PUBLISHING ---
        window.publishAllPages = async function() {
            const siteName = document.getElementById('site-name').value.trim().replace(/\s+/g, '-').toLowerCase();
            if (!siteName) return alert("Enter project name!");

            const status = document.getElementById('status-display');
            status.innerText = "Authenticating...";

            try {
                const result = await firebase.auth().signInWithPopup(new firebase.auth.GithubAuthProvider().addScope('repo'));
                const { accessToken } = result.credential;
                const user = result.additionalUserInfo.username;
                const octokit = new Octokit({ auth: accessToken });

                // Sync current page
                sitePages[activePage] = { html: editor.getHtml(), css: editor.getCss() };

                status.innerText = "ðŸš€ Deploying Site...";
                try { await octokit.request('POST /user/repos', { name: siteName, auto_init: true }); } catch (e) {}

                for (const [name, content] of Object.entries(sitePages)) {
                    const finalCode = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>${content.css}</style>
                        <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"><\/script>
                        </head><body>${content.html}
                        <script>
                            document.querySelectorAll('.paypal-container').forEach(el => {
                                const price = el.getAttribute('data-price');
                                const name = el.getAttribute('data-item');
                                el.innerHTML = '<div id="p-' + Math.random().toString(36).substr(2,5) + '"></div>';
                                paypal.Buttons({ createOrder: (d, a) => a.order.create({ purchase_units: [{ description: name, amount: { value: price } }] }) }).render(el.firstChild);
                            });
                        <\/script></body></html>`;

                    let sha = null;
                    try { const res = await octokit.repos.getContent({ owner: user, repo: siteName, path: name }); sha = res.data.sha; } catch(e){}

                    await octokit.repos.createOrUpdateFileContents({
                        owner: user, repo: siteName, path: name,
                        message: 'Deploy', content: btoa(unescape(encodeURIComponent(finalCode))), sha
                    });
                }

                await octokit.request('POST /repos/{owner}/{repo}/pages', { owner: user, repo: siteName, source: { branch: 'main', path: '/' } }).catch(e=>{});

                status.innerHTML = `<a href="https://${user}.github.io/${siteName}/" target="_blank" style="color:#2ea44f">OPEN LIVE SITE âž”</a>`;
            } catch (e) { alert(e.message); status.innerText = "Error"; }
        };

        // Initial render
        editor.setComponents(sitePages['index.html'].html);
        renderPageList();
    </script>
</body>
</html>
