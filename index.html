<!DOCTYPE html>
<html>
<head>
    <title>OpenBuilder | Full Suite</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root { --panel-bg: #1e1e1e; --border: #333; --accent: #3b82f6; --danger: #ef4444; }
        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: #111; color: white; overflow: hidden; }
        
        /* Unified Header */
        .app-header { 
            height: 45px; background: var(--panel-bg); display: flex; 
            justify-content: space-between; align-items: center; 
            padding: 0 10px; border-bottom: 1px solid var(--border);
            z-index: 1001; position: relative;
        }

        /* Sidebar Drawer for Cloud/Export */
        #sync-panel {
            width: 0; position: fixed; left: 0; top: 45px; bottom: 0;
            background: var(--panel-bg); border-right: 1px solid var(--border);
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; overflow-x: hidden;
            display: flex; flex-direction: column;
        }
        #sync-panel.open { width: 320px; padding: 20px; box-sizing: border-box; }

        /* Status & Toasts */
        #warning-toast {
            display: none; position: fixed; top: 55px; left: 50%; transform: translateX(-50%);
            background: #78350f; color: #fcd34d; padding: 8px 16px; border-radius: 4px;
            border: 1px solid #f59e0b; z-index: 2000; font-size: 12px;
        }
        #popup-toast { 
            display: none; position: fixed; bottom: 20px; left: 20px; 
            background: #f59e0b; color: #000; padding: 12px; border-radius: 6px; 
            z-index: 3000; font-weight: bold; font-size: 13px;
        }

        /* UI Elements */
        .btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.2s; }
        .btn-sync { background: var(--accent); color: white; }
        .btn-zip { background: #6366f1; color: white; }
        .btn-flat { background: #333; color: #ccc; margin-top: 5px; }
        .btn-danger { background: none; color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 20px; }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.1); }
        
        input, select { background: #111; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; font-size: 13px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        
        #gjs { height: calc(100vh - 45px) !important; }
    </style>
</head>
<body>

    <header class="app-header">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-sync" onclick="toggleSync()">‚òÅÔ∏è Settings & Sync</button>
            <button class="btn btn-zip" onclick="exportToZip()">üì¶ Download ZIP</button>
        </div>

        <div id="warning-toast">‚ö†Ô∏è Legacy Load: Site reconstructed from HTML (no project data found).</div>

        <div style="display:flex; gap:10px; align-items: center;">
            <input type="text" id="site-name" placeholder="Project Name" style="width:140px; margin:0; height:28px;">
            <button class="btn btn-sync" onclick="publishSite()">Publish to GitHub</button>
        </div>
    </header>

    <div id="popup-toast">‚ö†Ô∏è Pop-up Blocked? Please allow pop-ups to sign in with GitHub.</div>

    <div id="sync-panel">
        <h3 style="font-size:11px; color:#666; text-transform:uppercase; letter-spacing:1px; margin-bottom:15px;">GitHub Connectivity</h3>
        <button class="btn btn-sync" style="width:100%" id="auth-btn" onclick="connectGitHub()">Connect GitHub Account</button>
        
        <div id="repo-ui" style="display:none;">
            <label style="font-size:11px; color:#888;">SELECT REPOSITORY</label>
            <select id="repo-list"></select>
            <button class="btn btn-sync" style="width:100%" onclick="importProject()">üìÇ Load Selected Project</button>
            
            <div style="margin-top:40px; border-top:1px solid #333; padding-top:20px;">
                <h3 style="font-size:11px; color:#666; text-transform:uppercase;">Local Actions</h3>
                <button class="btn btn-flat" style="width:100%" onclick="resetCanvas()">‚ú® Clear Canvas</button>
                <button class="btn btn-danger" style="width:100%" onclick="deleteCurrentProject()">Delete Remote Repository</button>
            </div>
        </div>
    </div>

    <div id="gjs"></div>

    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";

        const firebaseConfig = { apiKey: "AIzaSyBtcrbgIblZlg5mqGJPaGTFctCoTPrY-WQ", authDomain: "web-maker-c6261.firebaseapp.com", projectId: "web-maker-c6261" };
        firebase.initializeApp(firebaseConfig);

        const editor = grapesjs.init({
            container: '#gjs',
            height: '100%',
            fromElement: true,
            storageManager: false,
            canvas: { styles: ['https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css'] },
            deviceManager: {
                devices: [
                    { name: 'Desktop', width: '' },
                    { name: 'Tablet', width: '768px', widthMedia: '992px' },
                    { name: 'Mobile', width: '320px', widthMedia: '480px' }
                ]
            },
            blockManager: {
                blocks: [
                    { id: 'section', label: 'Section', category: 'Layout', content: '<section style="padding:50px; text-align:center;"><h2>New Section</h2></section>' },
                    { id: 'grid-2', label: '2 Columns', category: 'Layout', content: '<div style="display:flex;"><div style="flex:1; padding:10px;">Col 1</div><div style="flex:1; padding:10px;">Col 2</div></div>' },
                    { id: 'text', label: 'Text', category: 'Basic', content: '<p>Edit this text</p>' },
                    { id: 'image', label: 'Image', category: 'Basic', content: { type: 'image' } },
                    { id: 'video', label: 'Video', category: 'Basic', content: { type: 'video' } },
                    { 
                        id: 'embed', 
                        label: '<b>Code Embed</b>', 
                        category: 'Advanced', 
                        content: {
                            type: 'default',
                            content: '<div style="padding:15px; border:1px dashed #444; color:#888; font-size:12px;">Custom Code Embed Box</div>',
                            traits: [{ type: 'textarea', label: 'HTML/JS Code', name: 'custom-code' }]
                        }
                    },
                    { 
                        id: 'paypal-product', 
                        label: 'PayPal Item', 
                        category: 'Commerce', 
                        content: {
                            type: 'paypal-card',
                            attributes: { 'data-price': '20.00', 'data-item': 'My Product' }
                        }
                    }
                ]
            }
        });

        // PayPal Component Logic
        editor.DomComponents.addType('paypal-card', {
            model: {
                defaults: {
                    traits: [
                        { type: 'text', label: 'Product Name', name: 'data-item' },
                        { type: 'number', label: 'Price ($)', name: 'data-price' }
                    ],
                    components: `
                        <div class="paypal-container" style="padding:20px; border:1px solid #eee; border-radius:8px; background:#fff; color:#111; text-align:center; max-width:260px; margin:auto;">
                            <h3 class="p-name">Product Name</h3>
                            <p style="font-size:1.5rem; font-weight:bold; margin:10px 0;">$<span class="p-price">20.00</span></p>
                            <div class="paypal-slot" style="background:#ffc439; padding:10px; border-radius:4px; font-weight:bold; cursor:default;">PayPal Checkout</div>
                        </div>`
                },
                init() { this.on('change:attributes:data-item change:attributes:data-price', this.updateUI); },
                updateUI() {
                    const attr = this.getAttributes();
                    const el = this.getEl();
                    if(el) {
                        el.querySelector('.p-name').innerText = attr['data-item'];
                        el.querySelector('.p-price').innerText = attr['data-price'];
                    }
                }
            }
        });

        // UI & ZIP EXPORT
        window.toggleSync = () => document.getElementById('sync-panel').classList.toggle('open');
        window.resetCanvas = () => confirm("Wipe everything and start fresh?") && editor.DomComponents.clear();

        window.exportToZip = async () => {
            const zip = new JSZip();
            const name = document.getElementById('site-name').value || "site-export";
            const html = `<!DOCTYPE html><html><head><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
            zip.file("index.html", html);
            zip.file("project-data.json", JSON.stringify(editor.getProjectData()));
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = `${name}.zip`;
            link.click();
        };

        // GITHUB CLOUD LOGIC
        let githubToken = "", githubUser = "";
        window.connectGitHub = async () => {
            const toast = document.getElementById('popup-toast');
            const timer = setTimeout(() => toast.style.display = 'block', 1500);
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo').addScope('delete_repo');
            
            try {
                const result = await firebase.auth().signInWithPopup(provider);
                clearTimeout(timer); toast.style.display = 'none';
                githubToken = result.credential.accessToken;
                githubUser = result.additionalUserInfo.username;
                document.getElementById('auth-btn').style.display = 'none';
                document.getElementById('repo-ui').style.display = 'block';
                fetchRepos();
            } catch (e) {
                clearTimeout(timer);
                if (e.code === 'auth/popup-blocked') toast.style.display = 'block';
                else alert(e.message);
            }
        };

        async function fetchRepos() {
            const octo = new Octokit({ auth: githubToken });
            const repos = await octo.repos.listForAuthenticatedUser({ sort: 'updated' });
            document.getElementById('repo-list').innerHTML = repos.data.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
        }

        window.importProject = async () => {
            const repo = document.getElementById('repo-list').value;
            const octo = new Octokit({ auth: githubToken });
            const warn = document.getElementById('warning-toast');
            warn.style.display = 'none';

            try {
                const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: 'project-data.json' });
                editor.loadProjectData(JSON.parse(atob(res.data.content)));
            } catch(e) {
                try {
                    const resHtml = await octo.repos.getContent({ owner: githubUser, repo: repo, path: 'index.html' });
                    editor.setComponents(atob(resHtml.data.content));
                    warn.style.display = 'block';
                } catch(e2) { alert("Repository appears empty."); }
            }
            document.getElementById('site-name').value = repo;
            toggleSync();
        };

        window.publishSite = async () => {
            const name = document.getElementById('site-name').value;
            if(!name || !githubToken) return alert("Please login and name your project.");
            const octo = new Octokit({ auth: githubToken });
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>${editor.getCss()}</style></head><body>${editor.getHtml()}</body></html>`;
            
            try {
                try { await octo.request('POST /user/repos', { name: name, auto_init: true }); } catch (e) {}
                await uploadFile(octo, name, 'project-data.json', JSON.stringify(editor.getProjectData()));
                await uploadFile(octo, name, 'index.html', html);
                alert("Successfully published to GitHub!");
            } catch(e) { alert(e.message); }
        };

        async function uploadFile(octo, repo, path, content) {
            let sha = null;
            try { const res = await octo.repos.getContent({ owner: githubUser, repo: repo, path: path }); sha = res.data.sha; } catch (e) {}
            return octo.repos.createOrUpdateFileContents({ owner: githubUser, repo: repo, path: path, message: 'Sync via OpenBuilder', content: btoa(unescape(encodeURIComponent(content))), sha });
        }

        window.deleteCurrentProject = async () => {
            const repo = document.getElementById('site-name').value;
            if(!repo || !confirm(`Permanently delete ${repo} from GitHub?`)) return;
            const octo = new Octokit({ auth: githubToken });
            await octo.repos.delete({ owner: githubUser, repo: repo });
            location.reload();
        };
    </script>
</body>
</html>
